<!DOCTYPE html>
<html lang="en" data-mode="light">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Integral Life Practice Tracker</title>
    <!-- Bootstrap 5.3 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <meta name="theme-color" content="#4f46e5">
    <style>
        /* Custom styles for consistency and aesthetics */
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bs-body-bg);
            color: var(--bs-body-color);
        }

        .cursor-pointer {
            cursor: pointer;
        }

        .card {
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: var(--bs-box-shadow-lg) !important;
        }
    </style>
</head>

<body class="min-vh-100">
    <div id="app" class="container py-4">
    </div>

    <!-- Bootstrap Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script type="module">


        // --- Global Variables (Provided by Canvas Environment) ---
        let auth = null;
        let userId = null;

        // State object replaces React's useState
        let state = {
            loading: true,
            error: '',
            config: [],
            dailyLog: {}, // Today's log (subset of allLogs)
            allLogs: {}, // All historical logs by date key
            view: 'tracker', // 'tracker', 'config', or 'history'
            newModuleName: '',
            newPracticeTexts: {}, // { moduleId: text, ... }
            darkMode: false,
            selectedLogDate: null,
            // NEW: Temporary state for day selection in config view
            tempFrequencyDays: {}
        };



        const getTodayDateKey = () => new Date().toISOString().split('T')[0];

        // Helper: Get today's day key (used for frequency check)
        const getTodayDayKey = () => ['sun', 'mon', 'tue', 'wed', 'thu', 'fri', 'sat'][new Date().getDay()];

        const CORE_MODULES = [
            // UPDATED: Changed 'completionRule' to 'frequency' object
            { id: 'body', name: 'Body', icon: '純', frequency: { rule: 'all', days: [] }, practices: ['Yoga', 'Cardio', 'Nutrition'] },
            { id: 'mind', name: 'Mind', icon: 'ｧ', frequency: { rule: 'all', days: [] }, practices: ['Study', 'Concentration', 'Journaling'] },
            { id: 'spirit', name: 'Spirit', icon: '笨ｨ', frequency: { rule: 'all', days: [] }, practices: ['Meditation', 'Contemplation'] },
            { id: 'shadow', name: 'Shadow', icon: '倦', frequency: { rule: 'all', days: [] }, practices: ['Inquiry', 'Therapy'] },
        ];

        const WEEK_DAYS = [
            { key: 'mon', name: 'Monday' },
            { key: 'tue', name: 'Tuesday' },
            { key: 'wed', name: 'Wednesday' },
            { key: 'thu', name: 'Thursday' },
            { key: 'fri', name: 'Friday' },
            { key: 'sat', name: 'Saturday' },
            { key: 'sun', name: 'Sunday' },
        ];


        // --- Dark Mode Logic (omitted for brevity, assumed unchanged) ---
        function getLocalDarkModeKey() { return `ilp_dark_mode`; }
        function loadDarkModePreference() {
            const isDark = localStorage.getItem(getLocalDarkModeKey()) === 'true';
            state.darkMode = isDark;
            applyDarkMode(isDark);
        }

        function saveDarkModePreference(isDark) {
            localStorage.setItem(getLocalDarkModeKey(), isDark ? 'true' : 'false');
            applyDarkMode(isDark);
        }

        function applyDarkMode(isDark) {
            const htmlEl = document.documentElement;
            if (isDark) {
                htmlEl.setAttribute('data-bs-theme', 'dark');
            } else {
                htmlEl.setAttribute('data-bs-theme', 'light');
            }
        }

        function toggleDarkMode() {
            const newMode = !state.darkMode;
            setState({ darkMode: newMode });
            saveDarkModePreference(newMode);
        }

        // --- Date/Week Helper Functions (omitted for brevity, assumed unchanged) ---

        /**
         * Calculates the Sunday (start) of the week for a given date key.
         * @param {string} dateKey - 'YYYY-MM-DD'
         * @returns {string} - 'YYYY-MM-DD' for Sunday
         */
        function getWeekStartKey(dateKey) {
            const date = new Date(dateKey + 'T00:00:00');
            const day = date.getDay(); // 0 is Sunday
            const weekStart = new Date(date);
            weekStart.setDate(date.getDate() - day);
            return weekStart.toISOString().split('T')[0];
        }

        /**
         * Formats the week range for display (Sunday - Saturday).
         * @param {string} weekStartKey - 'YYYY-MM-DD' for Sunday
         * @returns {string} - Formatted date range string
         */
        function formatWeekRange(weekStartKey) {
            const start = new Date(weekStartKey + 'T00:00:00');
            const end = new Date(start);
            end.setDate(start.getDate() + 6); // Saturday

            const startStr = start.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            const endStr = end.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });

            if (start.getFullYear() === end.getFullYear()) {
                return `${startStr} – ${end.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}`;
            }
            return `${startStr}, ${start.getFullYear()} – ${endStr}`;
        }

        // --- Core Logic Helper ---

        /**
         * Finds a module in config by its ID.
         * @param {string} moduleId 
         * @returns {Object|undefined}
         */
        function getModuleById(moduleId) {
            return state.config.find(m => m.id === moduleId);
        }

        /**
         * Determines if a module is scheduled for today.
         * @param {Object} module 
         * @param {string} dateKey - Optional date key (YYYY-MM-DD) for historical check
         * @returns {boolean}
         */
        function isModuleScheduledToday(module, dateKey = null) {
            const dayKey = dateKey ? ['sun', 'mon', 'tue', 'wed', 'thu', 'fri', 'sat'][new Date(dateKey + 'T00:00:00').getDay()] : getTodayDayKey();
            const freq = module.frequency;

            if (freq.rule === 'specific_days' && freq.days && freq.days.length > 0) {
                return freq.days.includes(dayKey);
            }
            // If rule is 'all', 'choose_one', or 'specific_days' with no days set, it defaults to daily.
            return true;
        }

        /**
         * Determines if a specific practice is scheduled for today.
         * @param {Object} practice
         * @param {string} dateKey - Optional date key
         * @returns {boolean}
         */
        function isPracticeScheduledToday(practice, dateKey = null) {
            const dayKey = dateKey ? ['sun', 'mon', 'tue', 'wed', 'thu', 'fri', 'sat'][new Date(dateKey + 'T00:00:00').getDay()] : getTodayDayKey();

            // If frequency is undefined or has no days, it defaults to ALL days the module is active
            if (!practice.frequency || !practice.frequency.days || practice.frequency.days.length === 0) {
                return true;
            }
            return practice.frequency.days.includes(dayKey);
        }

        /**
         * Determines if a module is completed based on its practices.
         * NOTE: This function checks scheduling of individual practices.
         * @param {Object} module 
         * @param {Object} dailyLog 
         * @param {string} dateKey
         * @returns {boolean}
         */
        function checkModulePracticesCompleted(module, dailyLog, dateKey = null) {
            if (!module.practices || module.practices.length === 0) return true;

            // Get only the practices scheduled for this specific day
            const scheduledPractices = module.practices.filter(p => isPracticeScheduledToday(p, dateKey));

            if (scheduledPractices.length === 0) return true; // Empty set is "complete" (nothing to do)

            const isPracticeCompleted = (p) => dailyLog[`${module.id}_${p.id}`] === 'completed';

            if (module.frequency.rule === 'choose_one') {
                return scheduledPractices.some(isPracticeCompleted);
            } else { // 'all'
                return scheduledPractices.every(isPracticeCompleted);
            }
        }

        /**
         * Determines if a module is completed based on its practices AND scheduling for today.
         * @param {Object} module 
         * @param {Object} dailyLog 
         * @param {string} dateKey - Date key for which the log applies (used for scheduling check)
         * @returns {boolean|'N/A'} - true/false or 'N/A' if not scheduled
         */
        function isModuleCompleted(module, dailyLog, dateKey = null) {
            if (!isModuleScheduledToday(module, dateKey)) {
                return 'N/A';
            }
            return checkModulePracticesCompleted(module, dailyLog);
        }

        // --- State Management and Renderer ---

        // Central function to update state and trigger a re-render
        function setState(updates) {
            // Shallow merge updates into the global state
            Object.assign(state, updates);
            renderApp();
        }

        // --- Auth/Listeners (Simplified for Local Storage) ---

        async function initApp() {
            loadDarkModePreference();
            // Local-only initialization
            userId = 'local-user-session';
            setState({ loading: false });
            loadConfig();
            loadDailyLog();
        }

        function getLocalConfigKey() { return `ilp_config_${userId}`; }
        function getLocalAllLogsKey() { return `ilp_all_logs_${userId}`; }

        // --- Data Loaders (Local Storage Readers) ---

        function loadConfig() {
            const configKey = getLocalConfigKey();
            const storedConfig = localStorage.getItem(configKey);

            if (storedConfig) {
                try {
                    const parsedConfig = JSON.parse(storedConfig).modules;
                    // MIGRATION/Normalization: ensure all modules have frequency and practices have frequency
                    const normalizedConfig = parsedConfig.map(m => ({
                        ...m,
                        frequency: m.frequency || { rule: m.completionRule || 'all', days: [] },
                        practices: (m.practices || []).map(p => ({
                            ...p,
                            frequency: p.frequency || { days: [] } // Default to empty array = 'all active days'
                        }))
                    }));
                    setState({ config: normalizedConfig });
                } catch (e) {
                    console.error("Error parsing stored config:", e);
                    initializeDefaultConfig();
                }
            } else if (state.config.length === 0) {
                initializeDefaultConfig();
            }
        }

        function initializeDefaultConfig() {
            // Initialize with default modules if no config exists
            const initialConfig = CORE_MODULES.map(m => ({
                ...m,
                practices: m.practices.map(p => ({
                    id: p.toLowerCase().replace(/\s/g, '_'),
                    name: p,
                    custom: false,
                    frequency: { days: [] }
                }))
            }));

            setState({ config: initialConfig });
            saveConfig(initialConfig);
        }


        function loadDailyLog() {
            const todayKey = getTodayDateKey();
            const logKey = getLocalAllLogsKey();
            const storedLogs = localStorage.getItem(logKey);

            let allLogs = {};
            if (storedLogs) {
                try {
                    allLogs = JSON.parse(storedLogs).logs || {};
                } catch (e) {
                    console.error("Error parsing stored logs:", e);
                }
            }

            const todayLog = allLogs[todayKey] ? allLogs[todayKey].practices : {};

            setState({
                dailyLog: todayLog,
                allLogs: allLogs
            });
        }

        // --- Data Handlers (Local Storage Writers) ---

        function saveConfig(newConfig) {
            if (!userId) return;
            const configKey = getLocalConfigKey();

            try {
                localStorage.setItem(configKey, JSON.stringify({ modules: newConfig, updatedAt: new Date().toISOString() }));
            } catch (e) {
                console.error("Error saving config to localStorage:", e);
                setState({ error: "Failed to save configuration locally." });
            }
        }

        function togglePractice(moduleId, practiceId, isChecked) {
            if (!userId) return;
            const todayKey = getTodayDateKey();
            const logKey = getLocalAllLogsKey();

            // 1. Update today's specific log state (dailyLog)
            const newDailyLog = {
                ...state.dailyLog,
                [`${moduleId}_${practiceId}`]: isChecked ? 'completed' : 'pending',
            };

            // 2. Update the full history object (allLogs)
            const updatedAllLogs = {
                ...state.allLogs,
                [todayKey]: {
                    date: todayKey,
                    practices: newDailyLog,
                    updatedAt: new Date().toISOString()
                }
            };

            try {
                setState({
                    dailyLog: newDailyLog,
                    allLogs: updatedAllLogs
                });

                localStorage.setItem(logKey, JSON.stringify({
                    logs: updatedAllLogs,
                    updatedAt: new Date().toISOString()
                }));
            } catch (e) {
                console.error("Error updating daily log in localStorage:", e);
                setState({ error: "Failed to update habit tracker locally." });
            }
        }

        // --- Config UI Handlers (UPDATED) ---

        function handleUpdateModuleFrequencyRule(moduleId, rule) {
            const newConfig = state.config.map(module => {
                if (module.id === moduleId) {
                    // Preserve days if switching back and forth from specific_days
                    const days = (module.frequency.days || []).slice();
                    return { ...module, frequency: { rule: rule, days: days } };
                }
                return module;
            });
            setState({ config: newConfig });
            saveConfig(newConfig);
        }

        function handleUpdateModuleFrequencyDays(moduleId, dayKey, isChecked) {
            const newConfig = state.config.map(module => {
                if (module.id === moduleId) {
                    let newDays = (module.frequency.days || []).slice();
                    if (isChecked && !newDays.includes(dayKey)) {
                        newDays.push(dayKey);
                    } else if (!isChecked && newDays.includes(dayKey)) {
                        newDays = newDays.filter(day => day !== dayKey);
                    }
                    // Sort days for consistency (Mon-Sun order)
                    const dayOrder = WEEK_DAYS.map(d => d.key);
                    newDays.sort((a, b) => dayOrder.indexOf(a) - dayOrder.indexOf(b));

                    return { ...module, frequency: { ...module.frequency, days: newDays } };
                }
                return module;
            });
            setState({ config: newConfig });
            saveConfig(newConfig);
        }

        function handleUpdatePracticeFrequencyDays(moduleId, practiceId, dayKey, isChecked) {
            const newConfig = state.config.map(module => {
                if (module.id === moduleId) {
                    const newPractices = module.practices.map(practice => {
                        if (practice.id === practiceId) {
                            let newDays = (practice.frequency && practice.frequency.days ? practice.frequency.days : []).slice();

                            if (isChecked && !newDays.includes(dayKey)) {
                                newDays.push(dayKey);
                            } else if (!isChecked && newDays.includes(dayKey)) {
                                newDays = newDays.filter(day => day !== dayKey);
                            }

                            const dayOrder = WEEK_DAYS.map(d => d.key);
                            newDays.sort((a, b) => dayOrder.indexOf(a) - dayOrder.indexOf(b));

                            return { ...practice, frequency: { days: newDays } };
                        }
                        return practice;
                    });

                    return { ...module, practices: newPractices };
                }
                return module;
            });
            setState({ config: newConfig });
            saveConfig(newConfig);
        }

        function handleAddModule(e) {
            e.preventDefault();
            const moduleName = state.newModuleName.trim();
            if (!moduleName) return;

            const newId = moduleName.toLowerCase().replace(/\s/g, '_') + Date.now();
            const newModule = {
                id: newId,
                name: moduleName,
                icon: '験',
                frequency: { rule: 'all', days: [] }, // NEW DEFAULT
                practices: [],
                custom: true,
            };
            const newConfig = [...state.config, newModule];

            setState({ newModuleName: '', config: newConfig });
            saveConfig(newConfig);
        }

        function handleAddPractice(e, moduleId) {
            e.preventDefault();
            const practiceText = state.newPracticeTexts[moduleId] || '';

            if (!practiceText.trim()) return;

            const newConfig = state.config.map(module => {
                if (module.id === moduleId) {
                    const newPractice = {
                        id: practiceText.trim().toLowerCase().replace(/\s/g, '_') + Date.now(),
                        name: practiceText.trim(),
                        custom: true,
                        frequency: { days: [] }
                    };
                    return {
                        ...module,
                        practices: [...module.practices, newPractice]
                    };
                }
                return module;
            });

            const newPracticeTexts = { ...state.newPracticeTexts, [moduleId]: '' };
            setState({ newPracticeTexts, config: newConfig });
            saveConfig(newConfig);
        }

        function handleRemovePractice(moduleId, practiceId) {
            const newConfig = state.config.map(module => {
                if (module.id === moduleId) {
                    return {
                        ...module,
                        practices: module.practices.filter(p => p.id !== practiceId)
                    };
                }
                return module;
            });
            setState({ config: newConfig });
            saveConfig(newConfig);
        }

        function handleRemoveModule(moduleId) {
            const newConfig = state.config.filter(m => m.id !== moduleId);
            setState({ config: newConfig });
            saveConfig(newConfig);
        }

        function handleDayLogClick(dateKey) {
            setState({ selectedLogDate: dateKey });
        }

        function handleCloseModal() {
            setState({ selectedLogDate: null });
        }

        // --- Export Feature ---

        function downloadTxtFile(filename, text) {
            const element = document.createElement('a');
            element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(text));
            element.setAttribute('download', filename);
            element.style.display = 'none';
            document.body.appendChild(element);
            element.click();
            document.body.removeChild(element);
        }

        function generateWeekTxt(weekStartKey) {
            const range = formatWeekRange(weekStartKey);
            let content = `INTEGRAL LIFE PRACTICE LOG\nWeek: ${range}\nGenerated: ${new Date().toLocaleString()}\n\n`;
            content += `========================================\n\n`;

            // Get all days in this week (Sun-Sat)
            const startDate = new Date(weekStartKey + 'T00:00:00');
            for (let i = 0; i < 7; i++) {
                const d = new Date(startDate);
                d.setDate(startDate.getDate() + i);
                const dateKey = d.toISOString().split('T')[0];
                const dayName = d.toLocaleDateString('en-US', { weekday: 'long' });

                content += `--- ${dayName}, ${dateKey} ---\n`;

                const logEntry = state.allLogs[dateKey];
                const practices = logEntry ? logEntry.practices : {};

                let scheduledCount = 0;
                let completedCount = 0;

                state.config.forEach(module => {
                    const status = isModuleCompleted(module, practices, dateKey);

                    if (status !== 'N/A') {
                        scheduledCount++;
                        const isDone = status === true;
                        if (isDone) completedCount++;

                        content += `[${isDone ? 'X' : ' '}] ${module.name} (${module.icon})\n`;

                        // List individual practices
                        if (module.practices.length > 0) {
                            module.practices.forEach(p => {
                                const pDone = practices[`${module.id}_${p.id}`] === 'completed';
                                content += `    - [${pDone ? 'x' : ' '}] ${p.name}\n`;
                            });
                        }
                        content += `\n`;
                    }
                });

                if (scheduledCount === 0) {
                    content += `(Rest Day / No Modules Scheduled)\n\n`;
                } else {
                    content += `Summary: ${completedCount}/${scheduledCount} Modules Completed\n\n`;
                }
            }

            return content;
        }

        function handleExportWeek(weekStartKey) {
            const content = generateWeekTxt(weekStartKey);
            const filename = `ILP_Log_${weekStartKey}.txt`;
            downloadTxtFile(filename, content);
        }


        // --- DOM Creation Utilities and Rendering ---

        // (renderLoadingState, renderErrorState, renderHeader are omitted for brevity, assumed unchanged)
        function renderLoadingState() {
            const div = document.createElement('div');
            div.className = "position-fixed top-0 start-0 w-100 h-100 d-flex flex-column align-items-center justify-content-center bg-body z-3";
            div.innerHTML = `
                <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-4 fs-5 fw-medium text-body-secondary">Loading your Integral Practice...</p>
            `;
            return div;
        }

        function renderErrorState() {
            const div = document.createElement('div');
            div.className = "alert alert-danger shadow-sm mt-4";
            div.innerHTML = `
                <h4 class="alert-heading fw-bold">System Error</h4>
                <p>${state.error}</p>
                <hr>
                <p class="mb-0 small">
                    If the error persists, please try reloading the page.
                    <br/>User Context: <span class="badge bg-danger-subtle text-danger-emphasis">${userId || 'N/A'}</span>
                    <br/>**Note: Data is saved to local browser storage only.**
                </p>
            `;
            return div;
        }

        function renderHeader() {
            const header = document.createElement('header');
            header.className = "d-flex flex-column flex-md-row justify-content-between align-items-center py-4 mb-5 border-bottom border-primary-subtle";

            // Title
            const h1 = document.createElement('h1');
            h1.className = "h3 fw-bold text-primary mb-3 mb-md-0 d-flex align-items-center";
            h1.innerHTML = '<span class="display-6 me-2">検</span> ILP Tracker';
            header.appendChild(h1);

            // Nav Buttons Container
            const navContainer = document.createElement('div');
            navContainer.className = "d-flex align-items-center gap-3 w-100 w-md-auto justify-content-between justify-content-md-end";

            // Nav Buttons
            const navDiv = document.createElement('div');
            navDiv.className = "btn-group";

            const createButton = (text, targetView) => {
                const btn = document.createElement('button');
                btn.textContent = text;
                btn.className = `btn ${state.view === targetView ? 'btn-primary' : 'btn-outline-primary'}`;
                btn.addEventListener('click', () => setState({ view: targetView }));
                return btn;
            };

            navDiv.appendChild(createButton('Daily Tracker', 'tracker'));
            navDiv.appendChild(createButton('Design ILP', 'config'));
            navDiv.appendChild(createButton('History', 'history'));
            navContainer.appendChild(navDiv);

            // Dark Mode Toggle Button
            const modeToggleBtn = document.createElement('button');
            modeToggleBtn.className = 'btn btn-outline-secondary rounded-circle p-2 lh-1';
            modeToggleBtn.innerHTML = state.darkMode
                ? '<i class="bi bi-moon-stars-fill"></i>'
                : '<i class="bi bi-sun-fill"></i>';

            modeToggleBtn.addEventListener('click', toggleDarkMode);
            navContainer.appendChild(modeToggleBtn);

            header.appendChild(navContainer);

            // User ID
            const userIdP = document.createElement('p');
            userIdP.className = "small text-muted mt-3 mt-md-0 text-md-end w-100 w-md-auto mb-0";
            userIdP.textContent = `Local User Context: ${userId}`;
            header.appendChild(userIdP);

            return header;
        }

        // --- Render Tracker View (UPDATED) ---
        function renderTrackerView() {
            const div = document.createElement('div');

            div.innerHTML = `<h2 class="h4 fw-bold text-body mb-4">Today's ILP <span class="badge bg-secondary-subtle text-secondary-emphasis rounded-pill fw-normal fs-6 ms-2">${getTodayDateKey()}</span></h2>`;

            const grid = document.createElement('div');
            grid.className = "row g-4";
            let modulesShown = 0;

            state.config.forEach(module => {
                if (isModuleScheduledToday(module)) {
                    grid.appendChild(createPracticeCard(module));
                    modulesShown++;
                }
            });

            if (modulesShown === 0) {
                grid.innerHTML = `<div class="col-12"><div class="alert alert-success d-flex align-items-center" role="alert">
                    <i class="bi bi-cup-hot-fill fs-4 me-3"></i>
                    <div>
                        No modules are scheduled for today (${new Date().toLocaleDateString('en-US', { weekday: 'long' })}). Enjoy your rest day!
                    </div>
                </div></div>`;
            }

            div.appendChild(grid);
            return div;
        }

        function createPracticeCard(module) {
            // Note: isModuleCompleted will return true/false here because we only call it if scheduled
            const moduleCompleted = checkModulePracticesCompleted(module, state.dailyLog);
            const isChooseOne = module.frequency.rule === 'choose_one';

            const col = document.createElement('div');
            col.className = 'col-12 col-md-6 col-lg-4';

            const card = document.createElement('div');
            card.className = `card h-100 ${moduleCompleted ? 'border-success' : 'border-0 shadow-sm'}`;
            if (moduleCompleted) card.style.borderWidth = '2px';

            const headerBg = moduleCompleted ? 'bg-success-subtle text-success-emphasis' : 'bg-body-secondary bg-opacity-50 text-body';

            const completionText = isChooseOne
                ? 'Complete <strong class="text-decoration-underline">ONE</strong> practice to finish.'
                : 'Complete <strong class="text-decoration-underline">ALL</strong> practices to finish.';

            card.innerHTML = `
                <div class="card-header ${headerBg} d-flex justify-content-between align-items-center border-bottom-0 py-3">
                    <h5 class="card-title mb-0 d-flex align-items-center">
                        <span class="fs-4 me-2">${module.icon}</span> 
                        ${module.name}
                    </h5>
                    ${moduleCompleted ? '<span class="badge bg-success">COMPLETED</span>' : ''}
                </div>
                <div class="card-body">
                    <p class="card-text small text-body-secondary mb-3 fst-italic">${completionText}</p>
                    <div class="list-group list-group-flush rounded-3" id="practices-list-${module.id}"></div>
                </div>
            `;

            const listGroup = card.querySelector(`#practices-list-${module.id}`);

            // Filter practices based on their specific schedule
            const scheduledPractices = module.practices.filter(p => isPracticeScheduledToday(p));

            if (scheduledPractices.length === 0) {
                listGroup.innerHTML = `<div class="text-center text-body-tertiary small fst-italic py-2">No practices scheduled for today.</div>`;
            }

            scheduledPractices.forEach(practice => {
                const isCompleted = state.dailyLog[`${module.id}_${practice.id}`] === 'completed';

                const item = document.createElement('button');
                item.type = 'button';
                item.className = `list-group-item list-group-item-action d-flex align-items-center gap-3 py-3 cursor-pointer ${isCompleted ? 'bg-success-subtle text-success text-decoration-line-through' : ''}`;

                item.addEventListener('click', () => togglePractice(module.id, practice.id, !isCompleted));

                item.innerHTML = `
                    <input class="form-check-input flex-shrink-0" type="checkbox" ${isCompleted ? 'checked' : ''} style="pointer-events: none;">
                    <span class="mb-0 flex-grow-1 ${isCompleted ? 'opacity-50' : ''}">${practice.name}</span>
                `;
                listGroup.appendChild(item);
            });

            col.appendChild(card);
            return col;
        }

        // --- Render Config View (UPDATED) ---
        function renderConfigView() {
            const div = document.createElement('div');
            // Using container-like spacing
            div.className = "d-flex flex-column gap-4";

            div.innerHTML = `
                <div class="mb-2">
                    <h2 class="h4 fw-bold text-body">Design Your Integral Life Practice</h2>
                    <p class="text-body-secondary">Add or remove practices in your modules. This is your personal blueprint!</p>
                </div>

                <form id="add-module-form" class="card shadow-sm border-primary-subtle">
                    <div class="card-body bg-primary-subtle bg-opacity-10">
                        <h5 class="card-title text-primary mb-3">Add a New Module</h5>
                        <div class="input-group">
                            <input
                                type="text"
                                id="new-module-name"
                                value="${state.newModuleName}"
                                placeholder="Module Name (e.g., 'Work Mastery')"
                                class="form-control"
                            />
                            <button type="submit" class="btn btn-primary">
                                Add Module
                            </button>
                        </div>
                    </div>
                </form>

                <div id="module-list" class="d-flex flex-column gap-4"></div>
            `;

            const form = div.querySelector('#add-module-form');
            form.addEventListener('submit', handleAddModule);
            const input = div.querySelector('#new-module-name');
            input.addEventListener('input', (e) => {
                state.newModuleName = e.target.value;
            });


            const moduleListContainer = div.querySelector('#module-list');

            state.config.forEach(module => {
                const moduleDiv = document.createElement('div');
                moduleDiv.className = "card shadow-sm";

                const currentRule = module.frequency.rule;
                const currentDays = module.frequency.days || [];

                // Build the Day Selection interface if the rule is 'specific_days'
                const daySelectionHtml = currentRule === 'specific_days' ? `
                    <div class="mt-3">
                        <label class="form-label small fw-semibold text-body-secondary">Select Days:</label>
                        <div class="d-flex flex-wrap gap-2">
                            ${WEEK_DAYS.map(day => `
                                <input 
                                    type="checkbox" 
                                    class="btn-check day-selector" 
                                    id="btn-check-${module.id}-${day.key}" 
                                    autocomplete="off"
                                    data-module-id="${module.id}" 
                                    data-day-key="${day.key}"
                                    ${currentDays.includes(day.key) ? 'checked' : ''}
                                >
                                <label class="btn btn-outline-primary btn-sm" for="btn-check-${module.id}-${day.key}">${day.name.substring(0, 3)}</label>
                            `).join('')}
                        </div>
                        <div class="form-text small fst-italic mt-1">Module is only visible on selected days in the tracker.</div>
                    </div>
                ` : '';


                moduleDiv.innerHTML = `
                    <div class="card-header bg-transparent d-flex justify-content-between align-items-center py-3">
                        <h4 class="h5 fw-bold mb-0 d-flex align-items-center text-body">
                            <span class="me-2 fs-4">${module.icon}</span> 
                            ${module.name}
                        </h4>
                        ${module.custom ? `<button data-module-id="${module.id}" class="remove-module-btn btn btn-outline-danger btn-sm">
                            Remove Module
                        </button>` : ''}
                    </div>

                    <div class="card-body">
                        <div class="mb-4 p-3 bg-body-tertiary rounded border">
                            <label class="form-label small fw-semibold text-body-secondary">Module Rule & Frequency:</label>
                            <div class="d-flex flex-column gap-2">
                                <select 
                                    class="form-select module-rule-selector"
                                    data-module-id="${module.id}"
                                >
                                    <option value="all" ${currentRule === 'all' ? 'selected' : ''}>Complete ALL Practices (Daily)</option>
                                    <option value="choose_one" ${currentRule === 'choose_one' ? 'selected' : ''}>Complete ONE Practice (Daily)</option>
                                    <option value="specific_days" ${currentRule === 'specific_days' ? 'selected' : ''}>Specific Days (Custom Frequency)</option>
                                </select>
                                
                                ${daySelectionHtml}
                            </div>
                        </div>

                        <ul class="list-group list-group-flush mb-4 rounded border-0">
                            ${module.practices.map(practice => {
                    const pDays = (practice.frequency && practice.frequency.days) || [];
                    const isScheduled = pDays.length > 0;

                    return `
                                <li key="${practice.id}" class="list-group-item d-flex flex-column gap-2 p-3">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <span class="fw-semibold text-body">${practice.name}</span>
                                        <button data-module-id="${module.id}" data-practice-id="${practice.id}" class="remove-practice-btn btn btn-sm btn-link text-danger text-decoration-none p-0">
                                            &times; Remove
                                        </button>
                                    </div>
                                    
                                    <div class="d-flex align-items-center gap-2">
                                        <span class="small text-body-secondary fw-medium">Schedule:</span>
                                        <div class="btn-group btn-group-sm" role="group">
                                            ${WEEK_DAYS.map(day => `
                                                <input 
                                                    type="checkbox" 
                                                    class="btn-check practice-day-selector"
                                                    id="p-day-${module.id}-${practice.id}-${day.key}"
                                                    autocomplete="off"
                                                    data-module-id="${module.id}" 
                                                    data-practice-id="${practice.id}"
                                                    data-day-key="${day.key}"
                                                    ${pDays.includes(day.key) ? 'checked' : ''}
                                                >
                                                <label class="btn btn-outline-secondary py-0 px-2" style="font-size: 0.75rem;" for="p-day-${module.id}-${practice.id}-${day.key}">
                                                    ${day.name.charAt(0)}
                                                </label>
                                            `).join('')}
                                        </div>
                                    </div>
                                    <div class="form-text mt-0" style="font-size: 0.7rem;">
                                        ${isScheduled ? 'Active only on selected days.' : 'Active EVERY day the module is active.'}
                                    </div>
                                </li>
                            `}).join('')}
                        </ul>

                        <form data-module-id="${module.id}" class="add-practice-form input-group">
                            <input
                                type="text"
                                data-module-id="${module.id}"
                                value="${state.newPracticeTexts[module.id] || ''}"
                                placeholder="New practice for ${module.name}"
                                class="practice-input form-control form-control-sm"
                            />
                            <button
                                type="submit"
                                class="btn btn-primary btn-sm"
                            >
                                Add Practice
                            </button>
                        </form>
                    </div>
                `;

                moduleListContainer.appendChild(moduleDiv);
            });

            // Setup event listeners for the dynamically created elements

            // Rule Selector
            div.querySelectorAll('.module-rule-selector').forEach(select => {
                select.addEventListener('change', (e) => {
                    handleUpdateModuleFrequencyRule(e.target.dataset.moduleId, e.target.value);
                });
            });

            // Day Selector Checkboxes
            div.querySelectorAll('.day-selector').forEach(checkbox => {
                checkbox.addEventListener('change', (e) => {
                    handleUpdateModuleFrequencyDays(e.target.dataset.moduleId, e.target.dataset.dayKey, e.target.checked);
                });
            });

            // Day Selector Checkboxes (Practice Level)
            div.querySelectorAll('.practice-day-selector').forEach(checkbox => {
                checkbox.addEventListener('change', (e) => {
                    handleUpdatePracticeFrequencyDays(e.target.dataset.moduleId, e.target.dataset.practiceId, e.target.dataset.dayKey, e.target.checked);
                });
            });

            // Remove Module, Remove Practice, Add Practice Form, Practice Input handlers (unchanged)
            div.querySelectorAll('.remove-module-btn').forEach(btn => {
                btn.addEventListener('click', (e) => handleRemoveModule(e.target.dataset.moduleId));
            });
            // ... (other handlers)
            div.querySelectorAll('.remove-practice-btn').forEach(btn => {
                btn.addEventListener('click', (e) => handleRemovePractice(e.target.dataset.moduleId, e.target.dataset.practiceId));
            });

            div.querySelectorAll('.add-practice-form').forEach(form => {
                form.addEventListener('submit', (e) => handleAddPractice(e, form.dataset.moduleId));
            });

            div.querySelectorAll('.practice-input').forEach(input => {
                input.addEventListener('input', (e) => {
                    const moduleId = e.target.dataset.moduleId;
                    state.newPracticeTexts = { ...state.newPracticeTexts, [moduleId]: e.target.value };
                });
            });

            return div;
        }

        // --- Render History View (UPDATED for 'N/A' status) ---
        function renderHistoryView() {
            const div = document.createElement('div');
            div.className = "d-flex flex-column gap-4";

            div.innerHTML = `
                <div class="mb-2">
                    <h2 class="h4 fw-bold text-body">Practice History Review</h2>
                    <p class="text-body-secondary">Review your past <strong>Module Completion Rate</strong>. Click on a day to see details!</p>
                </div>
            `;

            const historyContainer = document.createElement('div');
            historyContainer.className = "d-flex flex-column gap-4";

            const logDates = Object.keys(state.allLogs).sort(); // Sort ascending for weekly grouping

            if (logDates.length === 0) {
                historyContainer.innerHTML = '<div class="alert alert-warning">No practice logs found yet. Start tracking your habits on the Daily Tracker!</div>';
            } else {
                // Group logs by week (Sunday start)
                const logsByWeek = {};
                for (const dateKey of logDates) {
                    const weekStartKey = getWeekStartKey(dateKey);
                    if (!logsByWeek[weekStartKey]) {
                        logsByWeek[weekStartKey] = [];
                    }
                    logsByWeek[weekStartKey].push(dateKey);
                }

                const weekKeys = Object.keys(logsByWeek).sort().reverse();

                const todayKey = getTodayDateKey();
                const totalModules = state.config.length;

                weekKeys.forEach(weekStartKey => {
                    const weekDiv = document.createElement('div');
                    weekDiv.className = "card shadow-sm";

                    const weekHeader = document.createElement('div');
                    weekHeader.className = "card-header d-flex justify-content-between align-items-center bg-transparent py-3";

                    const title = document.createElement('h3');
                    title.className = "h5 fw-bold text-primary mb-0";
                    title.textContent = `Week of ${formatWeekRange(weekStartKey)}`;

                    const exportBtn = document.createElement('button');
                    exportBtn.textContent = "Export TXT";
                    exportBtn.className = "btn btn-outline-secondary btn-sm";
                    exportBtn.addEventListener('click', () => handleExportWeek(weekStartKey));

                    weekHeader.appendChild(title);
                    weekHeader.appendChild(exportBtn);

                    weekDiv.appendChild(weekHeader);

                    const dailyLogGrid = document.createElement('div');
                    dailyLogGrid.className = "card-body row g-3";

                    // Display days in order, descending
                    const weekLogs = logsByWeek[weekStartKey].sort().reverse();

                    weekLogs.forEach(dateKey => {
                        const logEntry = state.allLogs[dateKey];
                        const dateObj = new Date(dateKey + 'T00:00:00');
                        const dayOfWeek = dateObj.toLocaleDateString('en-US', { weekday: 'short' });

                        let completedModulesCount = 0;
                        let scheduledModulesCount = 0;

                        // Calculate stats based on the new isModuleCompleted logic
                        state.config.forEach(module => {
                            const status = isModuleCompleted(module, logEntry.practices, dateKey);
                            if (status !== 'N/A') {
                                scheduledModulesCount++;
                                if (status === true) {
                                    completedModulesCount++;
                                }
                            }
                        });


                        const completionPercentage = scheduledModulesCount > 0 ? Math.round((completedModulesCount / scheduledModulesCount) * 100) : 0;

                        const isToday = dateKey === todayKey;

                        const col = document.createElement('div');
                        col.className = 'col-12 col-md-6 col-lg-4';

                        const dayCard = document.createElement('div');
                        dayCard.className = `card h-100 cursor-pointer transition-all ${isToday ? 'border-primary shadow-sm bg-primary-subtle bg-opacity-10' : 'hover-shadow'}`;
                        if (isToday) dayCard.style.borderWidth = '2px';

                        dayCard.addEventListener('click', () => handleDayLogClick(dateKey));

                        dayCard.innerHTML = `
                            <div class="card-body p-3">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <span class="fw-bold text-body">${dayOfWeek}, ${dateObj.getDate()}</span>
                                    <span class="small font-monospace text-body-secondary">${dateKey.split('-').slice(1).join('/')}</span>
                                </div>
                                <div class="progress mb-2" style="height: 10px;">
                                    <div class="progress-bar" role="progressbar" style="width: ${completionPercentage}%" aria-valuenow="${completionPercentage}" aria-valuemin="0" aria-valuemax="100"></div>
                                </div>
                                <div class="d-flex justify-content-between small">
                                    <span class="text-body-secondary">${completedModulesCount}/${scheduledModulesCount} complete</span>
                                    <span class="fw-bold text-primary">${completionPercentage}%</span>
                                </div>
                            </div>
                        `;
                        col.appendChild(dayCard);
                        dailyLogGrid.appendChild(col);
                    });

                    weekDiv.appendChild(dailyLogGrid);
                    historyContainer.appendChild(weekDiv);
                });
            }

            div.appendChild(historyContainer);

            // Modal for Log Details
            if (state.selectedLogDate) {
                const modal = createLogDetailsModal(state.selectedLogDate);
                div.appendChild(modal);
            }

            return div;
        }

        function createLogDetailsModal(dateKey) {
            const logEntry = state.allLogs[dateKey] || { practices: {} };

            const backdrop = document.createElement('div');
            backdrop.className = "modal-backdrop fade show";

            const modal = document.createElement('div');
            modal.className = "modal fade show d-block";
            modal.tabIndex = -1;
            modal.setAttribute('role', 'dialog');
            modal.setAttribute('aria-modal', 'true');

            modal.addEventListener('click', (e) => {
                if (e.target === modal) handleCloseModal();
            });

            const dialog = document.createElement('div');
            dialog.className = "modal-dialog modal-dialog-centered modal-lg modal-dialog-scrollable";

            const content = document.createElement('div');
            content.className = "modal-content shadow";

            content.innerHTML = `
                <div class="modal-header">
                    <div>
                        <h5 class="modal-title fw-bold">Log Details</h5>
                        <small class="text-primary fw-medium">${new Date(dateKey + 'T00:00:00').toDateString()}</small>
                    </div>
                    <button type="button" class="btn-close" id="close-modal-btn" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="d-flex flex-column gap-3" id="modal-practices-container"></div>
                </div>
            `;

            const practicesContainer = content.querySelector('#modal-practices-container');

            // Reuse rendering logic basically but readonly
            state.config.forEach(module => {
                const status = isModuleCompleted(module, logEntry.practices, dateKey);
                if (status === 'N/A') return; // Skip if not scheduled

                const completed = status === true;

                // Filter practices for history view too
                const scheduledPractices = module.practices.filter(p => isPracticeScheduledToday(p, dateKey));

                const moduleDiv = document.createElement('div');
                moduleDiv.className = `border rounded p-3 ${completed ? "border-success bg-success-subtle bg-opacity-25" : "border-secondary-subtle"}`;

                moduleDiv.innerHTML = `
                    <div class="d-flex align-items-center gap-2 mb-2">
                        <div class="fs-4">${module.icon}</div>
                        <h5 class="mb-0 fw-bold ${completed ? "text-success-emphasis" : "text-body"}">${module.name}</h5>
                    </div>
                    <ul class="list-unstyled ms-4 mb-0 d-flex flex-column gap-1">
                        ${scheduledPractices.map(p => {
                    const pDone = logEntry.practices[`${module.id}_${p.id}`] === 'completed';
                    return `
                                <li class="small d-flex align-items-center gap-2 ${pDone ? "text-success fw-medium" : "text-body-secondary"}">
                                    <span class="d-inline-flex align-items-center justify-content-center border rounded ${pDone ? "bg-success border-success text-white" : "border-secondary-subtle"}" style="width: 16px; height: 16px; font-size: 10px;">
                                        ${pDone ? "✓" : ""}
                                    </span>
                                    ${p.name}
                                </li>
                             `
                }).join('')}
                    </ul>
                  `;
                practicesContainer.appendChild(moduleDiv);
            });

            if (practicesContainer.innerHTML === "") {
                practicesContainer.innerHTML = "<p class='text-muted fst-italic text-center my-4'>No modules were scheduled for this day.</p>";
            }

            const closeBtn = content.querySelector('#close-modal-btn');
            closeBtn.addEventListener('click', handleCloseModal);

            dialog.appendChild(content);
            modal.appendChild(dialog);

            // Wrap strictly for return, but need to append backdrop to body or handle it. 
            // Since we return a single element to append to #app, we can wrap both in a wrapper.
            // But usually modals are appended to body. Here we append to #app.
            // A wrapper div is easiest.
            const wrapper = document.createElement('div');
            wrapper.appendChild(backdrop);
            wrapper.appendChild(modal);

            return wrapper;
        }

        // --- Main Render Function ---

        function renderApp() {
            const app = document.getElementById('app');
            app.innerHTML = '';

            if (state.loading) {
                app.appendChild(renderLoadingState());
                return;
            }

            if (state.error) {
                app.appendChild(renderHeader());
                app.appendChild(renderErrorState());
                return;
            }

            app.appendChild(renderHeader());

            if (state.view === 'tracker') {
                app.appendChild(renderTrackerView());
            } else if (state.view === 'config') {
                app.appendChild(renderConfigView());
            } else if (state.view === 'history') {
                app.appendChild(renderHistoryView());
            }
        }

        // --- Initialization ---

        initApp();

    </script>
</body>

</html>