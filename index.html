<!DOCTYPE html>
<html lang="en" data-mode="light">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Integral Life Practice Tracker</title>
    <!-- Bootstrap 5.3 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <meta name="theme-color" content="#4f46e5">
    <style>
        /* --- Integral Design System (AQAL Theme) --- */
        :root {
            /* Core Palette: "Second Tier" Teal */
            --integral-teal-dark: #0f3c4c;
            /* Deep Kosmic Blue/Teal */
            --integral-teal-mid: #1d6e7e;
            /* Evolutionary Teal */
            --integral-teal-light: #56cbf9;
            /* Turquoise/Cyan Accent */

            /* Module Colors (The 4 Quadrants) */
            --mod-body: #e76f51;
            /* Physical/Behavioral (Orange/Red) */
            --mod-mind: #2a9d8f;
            /* Intellectual (Teal/Green) */
            --mod-spirit: #a594f9;
            /* Transpersonal (Violet/Gold) */
            --mod-shadow: #10b981;
            /* Emerald (Growth/Healing) */

            /* Neutral / Glass */
            --glass-bg: rgba(255, 255, 255, 0.7);
            --glass-border: rgba(255, 255, 255, 0.5);
            --glass-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
        }

        [data-bs-theme="dark"] {
            --integral-teal-dark: #051923;
            --integral-teal-mid: #003554;
            --integral-teal-light: #00a6fb;

            --glass-bg: rgba(15, 23, 42, 0.6);
            --glass-border: rgba(255, 255, 255, 0.1);
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, var(--integral-teal-light) 0%, var(--integral-teal-mid) 100%);
            background-attachment: fixed;
            /* Parallax feel */
            color: #1e293b;
            min-height: 100vh;
        }

        [data-bs-theme="dark"] body {
            background: linear-gradient(135deg, var(--integral-teal-dark) 0%, var(--integral-teal-mid) 100%);
            color: #f1f5f9;
        }

        /* Glassmorphism Utilities */
        .glass-panel {
            background: var(--glass-bg);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
            border-radius: 1.5rem;
            /* Organic roundness */
            box-shadow: var(--glass-shadow);
        }

        .glass-header {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(8px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.3);
        }

        [data-bs-theme="dark"] .glass-header {
            background: rgba(15, 23, 42, 0.85);
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        /* Holon Cards (Floating, distinct) */
        .holon-card {
            transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
            border: none;
            overflow: hidden;
            background: var(--glass-bg);
            position: relative;
        }

        .holon-card:hover {
            transform: translateY(-5px) scale(1.02);
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.15);
            z-index: 10;
        }

        /* Transcend and Include Effect */
        .holon-card.integrated {
            box-shadow: 0 0 20px rgba(var(--mod-color-rgb), 0.4), var(--glass-shadow);
            border-color: transparent !important;
            /* Glow replaces border */
        }

        .holon-card.integrated::before {
            content: '';
            position: absolute;
            inset: 0;
            background: radial-gradient(circle at top right, rgba(255, 255, 255, 0.4), transparent 70%);
            pointer-events: none;
        }

        /* Typography Override */
        h1,
        h2,
        h3,
        h4,
        h5,
        h6 {
            font-weight: 700;
            letter-spacing: -0.02em;
            /* Tight, modern tracking */
        }

        /* Module Specificaccents */
        .accent-body {
            color: var(--mod-body) !important;
            --mod-color-rgb: 231, 111, 81;
        }

        .accent-mind {
            color: var(--mod-mind) !important;
            --mod-color-rgb: 42, 157, 143;
        }

        .accent-spirit {
            color: var(--mod-spirit) !important;
            --mod-color-rgb: 165, 148, 249;
        }

        .accent-shadow {
            color: var(--mod-shadow) !important;
            --mod-color-rgb: 16, 185, 129;
        }

        .border-body {
            border-color: var(--mod-body) !important;
        }

        .border-mind {
            border-color: var(--mod-mind) !important;
        }

        .border-spirit {
            border-color: var(--mod-spirit) !important;
        }

        .border-shadow {
            border-color: var(--mod-shadow) !important;
        }

        .bg-gradient-body {
            background: linear-gradient(135deg, var(--mod-body), #f4a261);
            color: white;
        }

        .bg-gradient-mind {
            background: linear-gradient(135deg, var(--mod-mind), #264653);
            color: white;
        }

        .bg-gradient-spirit {
            background: linear-gradient(135deg, var(--mod-spirit), #7b2cbf);
            color: white;
        }

        .bg-gradient-shadow {
            background: linear-gradient(135deg, var(--mod-shadow), #34d399);
            color: white;
        }

        /* Mandala Progress Ring */
        .mandala-ring {
            transform: rotate(-90deg);
            transform-origin: 50% 50%;
        }

        .mandala-circle-bg {
            fill: none;
            stroke: rgba(255, 255, 255, 0.2);
            stroke-width: 8;
        }

        [data-bs-theme="light"] .mandala-circle-bg {
            stroke: rgba(0, 0, 0, 0.05);
        }

        .mandala-circle-progress {
            fill: none;
            stroke: url(#cosmosGradient);
            stroke-width: 8;
            stroke-linecap: round;
            stroke-dasharray: 251;
            /* 2 * PI * r (r=40) => ~251 */
            stroke-dashoffset: 251;
            transition: stroke-dashoffset 1s ease-in-out;
        }


        /* Custom Scrollbar for inner lists */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
        }

        [data-bs-theme="dark"] ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
        }
    </style>
</head>

<body class="min-vh-100">
    <div id="app" class="container py-4">
    </div>

    <!-- Bootstrap Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script type="module">


        // --- Global Variables (Provided by Canvas Environment) ---
        let auth = null;
        let userId = null;

        // State object replaces React's useState
        let state = {
            loading: true,
            error: '',
            config: [],
            dailyLog: {}, // Today's log (subset of allLogs)
            allLogs: {}, // All historical logs by date key
            view: 'tracker', // 'tracker', 'config', or 'history'
            newModuleName: '',
            newPracticeTexts: {}, // { moduleId: text, ... }
            darkMode: false,
            selectedLogDate: null,
            // NEW: Temporary state for day selection in config view
            tempFrequencyDays: {}
        };



        const getTodayDateKey = () => new Date().toISOString().split('T')[0];

        // Helper: Get today's day key (used for frequency check)
        const getTodayDayKey = () => ['sun', 'mon', 'tue', 'wed', 'thu', 'fri', 'sat'][new Date().getDay()];

        const CORE_MODULES = [
            // UPDATED: Changed 'completionRule' to 'frequency' object
            { id: 'body', name: 'Body', icon: '純', frequency: { rule: 'all', days: [] }, practices: ['Yoga', 'Cardio', 'Nutrition'] },
            { id: 'mind', name: 'Mind', icon: 'ｧ', frequency: { rule: 'all', days: [] }, practices: ['Study', 'Concentration', 'Journaling'] },
            { id: 'spirit', name: 'Spirit', icon: '笨ｨ', frequency: { rule: 'all', days: [] }, practices: ['Meditation', 'Contemplation'] },
            { id: 'shadow', name: 'Shadow', icon: '倦', frequency: { rule: 'all', days: [] }, practices: ['Inquiry', 'Therapy'] },
        ];

        const WEEK_DAYS = [
            { key: 'mon', name: 'Monday' },
            { key: 'tue', name: 'Tuesday' },
            { key: 'wed', name: 'Wednesday' },
            { key: 'thu', name: 'Thursday' },
            { key: 'fri', name: 'Friday' },
            { key: 'sat', name: 'Saturday' },
            { key: 'sun', name: 'Sunday' },
        ];


        // --- Dark Mode Logic (omitted for brevity, assumed unchanged) ---
        function getLocalDarkModeKey() { return `ilp_dark_mode`; }
        function loadDarkModePreference() {
            const isDark = localStorage.getItem(getLocalDarkModeKey()) === 'true';
            state.darkMode = isDark;
            applyDarkMode(isDark);
        }

        function saveDarkModePreference(isDark) {
            localStorage.setItem(getLocalDarkModeKey(), isDark ? 'true' : 'false');
            applyDarkMode(isDark);
        }

        function applyDarkMode(isDark) {
            const htmlEl = document.documentElement;
            if (isDark) {
                htmlEl.setAttribute('data-bs-theme', 'dark');
            } else {
                htmlEl.setAttribute('data-bs-theme', 'light');
            }
        }

        function toggleDarkMode() {
            const newMode = !state.darkMode;
            setState({ darkMode: newMode });
            saveDarkModePreference(newMode);
        }

        // --- Date/Week Helper Functions (omitted for brevity, assumed unchanged) ---

        /**
         * Calculates the Sunday (start) of the week for a given date key.
         * @param {string} dateKey - 'YYYY-MM-DD'
         * @returns {string} - 'YYYY-MM-DD' for Sunday
         */
        function getWeekStartKey(dateKey) {
            const date = new Date(dateKey + 'T00:00:00');
            const day = date.getDay(); // 0 is Sunday
            const weekStart = new Date(date);
            weekStart.setDate(date.getDate() - day);
            return weekStart.toISOString().split('T')[0];
        }

        /**
         * Formats the week range for display (Sunday - Saturday).
         * @param {string} weekStartKey - 'YYYY-MM-DD' for Sunday
         * @returns {string} - Formatted date range string
         */
        function formatWeekRange(weekStartKey) {
            const start = new Date(weekStartKey + 'T00:00:00');
            const end = new Date(start);
            end.setDate(start.getDate() + 6); // Saturday

            const startStr = start.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            const endStr = end.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });

            if (start.getFullYear() === end.getFullYear()) {
                return `${startStr} – ${end.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}`;
            }
            return `${startStr}, ${start.getFullYear()} – ${endStr}`;
        }

        // --- Core Logic Helper ---

        /**
         * Finds a module in config by its ID.
         * @param {string} moduleId 
         * @returns {Object|undefined}
         */
        function getModuleById(moduleId) {
            return state.config.find(m => m.id === moduleId);
        }

        /**
         * Determines if a module is scheduled for today.
         * @param {Object} module 
         * @param {string} dateKey - Optional date key (YYYY-MM-DD) for historical check
         * @returns {boolean}
         */
        function isModuleScheduledToday(module, dateKey = null) {
            const dayKey = dateKey ? ['sun', 'mon', 'tue', 'wed', 'thu', 'fri', 'sat'][new Date(dateKey + 'T00:00:00').getDay()] : getTodayDayKey();
            const freq = module.frequency;

            if (freq.rule === 'specific_days' && freq.days && freq.days.length > 0) {
                return freq.days.includes(dayKey);
            }
            // If rule is 'all', 'choose_one', or 'specific_days' with no days set, it defaults to daily.
            return true;
        }

        /**
         * Determines if a specific practice is scheduled for today.
         * @param {Object} practice
         * @param {string} dateKey - Optional date key
         * @returns {boolean}
         */
        function isPracticeScheduledToday(practice, dateKey = null) {
            const dayKey = dateKey ? ['sun', 'mon', 'tue', 'wed', 'thu', 'fri', 'sat'][new Date(dateKey + 'T00:00:00').getDay()] : getTodayDayKey();

            // If frequency is undefined or has no days, it defaults to ALL days the module is active
            if (!practice.frequency || !practice.frequency.days || practice.frequency.days.length === 0) {
                return true;
            }
            return practice.frequency.days.includes(dayKey);
        }

        /**
         * Determines if a module is completed based on its practices.
         * NOTE: This function checks scheduling of individual practices.
         * @param {Object} module 
         * @param {Object} dailyLog 
         * @param {string} dateKey
         * @returns {boolean}
         */
        function checkModulePracticesCompleted(module, dailyLog, dateKey = null) {
            if (!module.practices || module.practices.length === 0) return true;

            // Get only the practices scheduled for this specific day
            const scheduledPractices = module.practices.filter(p => isPracticeScheduledToday(p, dateKey));

            if (scheduledPractices.length === 0) return true; // Empty set is "complete" (nothing to do)

            const isPracticeCompleted = (p) => dailyLog[`${module.id}_${p.id}`] === 'completed';

            if (module.frequency.rule === 'choose_one') {
                return scheduledPractices.some(isPracticeCompleted);
            } else { // 'all'
                return scheduledPractices.every(isPracticeCompleted);
            }
        }

        /**
         * Determines if a module is completed based on its practices AND scheduling for today.
         * @param {Object} module 
         * @param {Object} dailyLog 
         * @param {string} dateKey - Date key for which the log applies (used for scheduling check)
         * @returns {boolean|'N/A'} - true/false or 'N/A' if not scheduled
         */
        function isModuleCompleted(module, dailyLog, dateKey = null) {
            if (!isModuleScheduledToday(module, dateKey)) {
                return 'N/A';
            }
            return checkModulePracticesCompleted(module, dailyLog);
        }

        // --- State Management and Renderer ---

        // Central function to update state and trigger a re-render
        function setState(updates) {
            // Shallow merge updates into the global state
            Object.assign(state, updates);
            renderApp();
        }

        // --- Auth/Listeners (Simplified for Local Storage) ---

        async function initApp() {
            loadDarkModePreference();
            // Local-only initialization
            userId = 'local-user-session';
            setState({ loading: false });
            loadConfig();
            loadDailyLog();
        }

        function getLocalConfigKey() { return `ilp_config_${userId}`; }
        function getLocalAllLogsKey() { return `ilp_all_logs_${userId}`; }

        // --- Data Loaders (Local Storage Readers) ---

        function loadConfig() {
            const configKey = getLocalConfigKey();
            const storedConfig = localStorage.getItem(configKey);

            if (storedConfig) {
                try {
                    const parsedConfig = JSON.parse(storedConfig).modules;
                    // MIGRATION/Normalization: ensure all modules have frequency and practices have frequency
                    const normalizedConfig = parsedConfig.map(m => ({
                        ...m,
                        frequency: m.frequency || { rule: m.completionRule || 'all', days: [] },
                        practices: (m.practices || []).map(p => ({
                            ...p,
                            frequency: p.frequency || { days: [] } // Default to empty array = 'all active days'
                        }))
                    }));
                    setState({ config: normalizedConfig });
                } catch (e) {
                    console.error("Error parsing stored config:", e);
                    initializeDefaultConfig();
                }
            } else if (state.config.length === 0) {
                initializeDefaultConfig();
            }
        }

        function initializeDefaultConfig() {
            // Initialize with default modules if no config exists
            const initialConfig = CORE_MODULES.map(m => ({
                ...m,
                practices: m.practices.map(p => ({
                    id: p.toLowerCase().replace(/\s/g, '_'),
                    name: p,
                    custom: false,
                    frequency: { days: [] }
                }))
            }));

            setState({ config: initialConfig });
            saveConfig(initialConfig);
        }


        function loadDailyLog() {
            const todayKey = getTodayDateKey();
            const logKey = getLocalAllLogsKey();
            const storedLogs = localStorage.getItem(logKey);

            let allLogs = {};
            if (storedLogs) {
                try {
                    allLogs = JSON.parse(storedLogs).logs || {};
                } catch (e) {
                    console.error("Error parsing stored logs:", e);
                }
            }

            const todayLog = allLogs[todayKey] ? allLogs[todayKey].practices : {};

            setState({
                dailyLog: todayLog,
                allLogs: allLogs
            });
        }

        // --- Data Handlers (Local Storage Writers) ---

        function saveConfig(newConfig) {
            if (!userId) return;
            const configKey = getLocalConfigKey();

            try {
                localStorage.setItem(configKey, JSON.stringify({ modules: newConfig, updatedAt: new Date().toISOString() }));
            } catch (e) {
                console.error("Error saving config to localStorage:", e);
                setState({ error: "Failed to save configuration locally." });
            }
        }

        function togglePractice(moduleId, practiceId, isChecked) {
            if (!userId) return;
            const todayKey = getTodayDateKey();
            const logKey = getLocalAllLogsKey();

            // 1. Update today's specific log state (dailyLog)
            const newDailyLog = {
                ...state.dailyLog,
                [`${moduleId}_${practiceId}`]: isChecked ? 'completed' : 'pending',
            };

            // 2. Update the full history object (allLogs)
            const updatedAllLogs = {
                ...state.allLogs,
                [todayKey]: {
                    date: todayKey,
                    practices: newDailyLog,
                    updatedAt: new Date().toISOString()
                }
            };

            try {
                setState({
                    dailyLog: newDailyLog,
                    allLogs: updatedAllLogs
                });

                localStorage.setItem(logKey, JSON.stringify({
                    logs: updatedAllLogs,
                    updatedAt: new Date().toISOString()
                }));
            } catch (e) {
                console.error("Error updating daily log in localStorage:", e);
                setState({ error: "Failed to update habit tracker locally." });
            }
        }

        // --- Config UI Handlers (UPDATED) ---

        function handleUpdateModuleFrequencyRule(moduleId, rule) {
            const newConfig = state.config.map(module => {
                if (module.id === moduleId) {
                    // Preserve days if switching back and forth from specific_days
                    const days = (module.frequency.days || []).slice();
                    return { ...module, frequency: { rule: rule, days: days } };
                }
                return module;
            });
            setState({ config: newConfig });
            saveConfig(newConfig);
        }

        function handleUpdateModuleFrequencyDays(moduleId, dayKey, isChecked) {
            const newConfig = state.config.map(module => {
                if (module.id === moduleId) {
                    let newDays = (module.frequency.days || []).slice();
                    if (isChecked && !newDays.includes(dayKey)) {
                        newDays.push(dayKey);
                    } else if (!isChecked && newDays.includes(dayKey)) {
                        newDays = newDays.filter(day => day !== dayKey);
                    }
                    // Sort days for consistency (Mon-Sun order)
                    const dayOrder = WEEK_DAYS.map(d => d.key);
                    newDays.sort((a, b) => dayOrder.indexOf(a) - dayOrder.indexOf(b));

                    return { ...module, frequency: { ...module.frequency, days: newDays } };
                }
                return module;
            });
            setState({ config: newConfig });
            saveConfig(newConfig);
        }

        function handleUpdatePracticeFrequencyDays(moduleId, practiceId, dayKey, isChecked) {
            const newConfig = state.config.map(module => {
                if (module.id === moduleId) {
                    const newPractices = module.practices.map(practice => {
                        if (practice.id === practiceId) {
                            let newDays = (practice.frequency && practice.frequency.days ? practice.frequency.days : []).slice();

                            if (isChecked && !newDays.includes(dayKey)) {
                                newDays.push(dayKey);
                            } else if (!isChecked && newDays.includes(dayKey)) {
                                newDays = newDays.filter(day => day !== dayKey);
                            }

                            const dayOrder = WEEK_DAYS.map(d => d.key);
                            newDays.sort((a, b) => dayOrder.indexOf(a) - dayOrder.indexOf(b));

                            return { ...practice, frequency: { days: newDays } };
                        }
                        return practice;
                    });

                    return { ...module, practices: newPractices };
                }
                return module;
            });
            setState({ config: newConfig });
            saveConfig(newConfig);
        }

        function handleAddModule(e) {
            e.preventDefault();
            const moduleName = state.newModuleName.trim();
            if (!moduleName) return;

            const newId = moduleName.toLowerCase().replace(/\s/g, '_') + Date.now();
            const newModule = {
                id: newId,
                name: moduleName,
                icon: '験',
                frequency: { rule: 'all', days: [] }, // NEW DEFAULT
                practices: [],
                custom: true,
            };
            const newConfig = [...state.config, newModule];

            setState({ newModuleName: '', config: newConfig });
            saveConfig(newConfig);
        }

        function handleAddPractice(e, moduleId) {
            e.preventDefault();
            const practiceText = state.newPracticeTexts[moduleId] || '';

            if (!practiceText.trim()) return;

            const newConfig = state.config.map(module => {
                if (module.id === moduleId) {
                    const newPractice = {
                        id: practiceText.trim().toLowerCase().replace(/\s/g, '_') + Date.now(),
                        name: practiceText.trim(),
                        custom: true,
                        frequency: { days: [] }
                    };
                    return {
                        ...module,
                        practices: [...module.practices, newPractice]
                    };
                }
                return module;
            });

            const newPracticeTexts = { ...state.newPracticeTexts, [moduleId]: '' };
            setState({ newPracticeTexts, config: newConfig });
            saveConfig(newConfig);
        }

        function handleRemovePractice(moduleId, practiceId) {
            const newConfig = state.config.map(module => {
                if (module.id === moduleId) {
                    return {
                        ...module,
                        practices: module.practices.filter(p => p.id !== practiceId)
                    };
                }
                return module;
            });
            setState({ config: newConfig });
            saveConfig(newConfig);
        }

        function handleRemoveModule(moduleId) {
            const newConfig = state.config.filter(m => m.id !== moduleId);
            setState({ config: newConfig });
            saveConfig(newConfig);
        }

        function handleDayLogClick(dateKey) {
            setState({ selectedLogDate: dateKey });
        }

        function handleCloseModal() {
            setState({ selectedLogDate: null });
        }

        // --- Export Feature ---

        function downloadTxtFile(filename, text) {
            const element = document.createElement('a');
            element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(text));
            element.setAttribute('download', filename);
            element.style.display = 'none';
            document.body.appendChild(element);
            element.click();
            document.body.removeChild(element);
        }

        function generateWeekTxt(weekStartKey) {
            const range = formatWeekRange(weekStartKey);
            let content = `INTEGRAL LIFE PRACTICE LOG\nWeek: ${range}\nGenerated: ${new Date().toLocaleString()}\n\n`;
            content += `========================================\n\n`;

            // Get all days in this week (Sun-Sat)
            const startDate = new Date(weekStartKey + 'T00:00:00');
            for (let i = 0; i < 7; i++) {
                const d = new Date(startDate);
                d.setDate(startDate.getDate() + i);
                const dateKey = d.toISOString().split('T')[0];
                const dayName = d.toLocaleDateString('en-US', { weekday: 'long' });

                content += `--- ${dayName}, ${dateKey} ---\n`;

                const logEntry = state.allLogs[dateKey];
                const practices = logEntry ? logEntry.practices : {};

                let scheduledCount = 0;
                let completedCount = 0;

                state.config.forEach(module => {
                    const status = isModuleCompleted(module, practices, dateKey);

                    if (status !== 'N/A') {
                        scheduledCount++;
                        const isDone = status === true;
                        if (isDone) completedCount++;

                        content += `[${isDone ? 'X' : ' '}] ${module.name} (${module.icon})\n`;

                        // List individual practices
                        if (module.practices.length > 0) {
                            module.practices.forEach(p => {
                                const pDone = practices[`${module.id}_${p.id}`] === 'completed';
                                content += `    - [${pDone ? 'x' : ' '}] ${p.name}\n`;
                            });
                        }
                        content += `\n`;
                    }
                });

                if (scheduledCount === 0) {
                    content += `(Rest Day / No Modules Scheduled)\n\n`;
                } else {
                    content += `Summary: ${completedCount}/${scheduledCount} Modules Completed\n\n`;
                }
            }

            return content;
        }

        function handleExportWeek(weekStartKey) {
            const content = generateWeekTxt(weekStartKey);
            const filename = `ILP_Log_${weekStartKey}.txt`;
            downloadTxtFile(filename, content);
        }


        // --- DOM Creation Utilities and Rendering ---

        // (renderLoadingState, renderErrorState, renderHeader are omitted for brevity, assumed unchanged)
        function renderLoadingState() {
            const div = document.createElement('div');
            div.className = "position-fixed top-0 start-0 w-100 h-100 d-flex flex-column align-items-center justify-content-center bg-body z-3";
            div.innerHTML = `
                <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-4 fs-5 fw-medium text-body-secondary">Loading your Integral Practice...</p>
            `;
            return div;
        }

        function renderErrorState() {
            const div = document.createElement('div');
            div.className = "alert alert-danger shadow-sm mt-4";
            div.innerHTML = `
                <h4 class="alert-heading fw-bold">System Error</h4>
                <p>${state.error}</p>
                <hr>
                <p class="mb-0 small">
                    If the error persists, please try reloading the page.
                    <br/>User Context: <span class="badge bg-danger-subtle text-danger-emphasis">${userId || 'N/A'}</span>
                    <br/>**Note: Data is saved to local browser storage only.**
                </p>
            `;
            return div;
        }

        function renderHeader() {
            const header = document.createElement('header');
            header.className = "glass-header sticky-top d-flex flex-column flex-md-row justify-content-between align-items-center py-3 px-4 mb-4 rounded-bottom-4 z-2";

            // Title
            const h1 = document.createElement('h1');
            h1.className = "h4 fw-bold text-body mb-3 mb-md-0 d-flex align-items-center tracking-tight";
            h1.innerHTML = `
                <span class="me-2 fs-3 text-gradient-primary">検</span> 
                <span style="background: linear-gradient(90deg, var(--integral-teal-mid), var(--integral-teal-light)); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">
                    ILP Tracker
                </span>
            `;
            header.appendChild(h1);

            // Nav Buttons Container
            const navContainer = document.createElement('div');
            navContainer.className = "d-flex align-items-center gap-2 w-100 w-md-auto justify-content-between justify-content-md-end";

            // Nav Buttons
            const navDiv = document.createElement('nav');
            navDiv.className = "nav nav-pills";

            const createButton = (text, targetView) => {
                const btn = document.createElement('a');
                btn.textContent = text;
                btn.className = `nav-link small text-uppercase fw-bold rounded-pill px-3 transition-all ${state.view === targetView ? 'active bg-gradient-mind shadow-sm' : 'text-body-secondary hover-bg-light'}`;
                btn.style.cursor = 'pointer';
                btn.addEventListener('click', () => setState({ view: targetView }));
                return btn;
            };

            navDiv.appendChild(createButton('Daily', 'tracker'));
            navDiv.appendChild(createButton('Design', 'config'));
            navDiv.appendChild(createButton('History', 'history'));
            navContainer.appendChild(navDiv);

            // Dark Mode Toggle Button
            const modeToggleBtn = document.createElement('button');
            modeToggleBtn.className = 'btn btn-outline-secondary rounded-circle p-2 lh-1';
            modeToggleBtn.innerHTML = state.darkMode
                ? '<i class="bi bi-moon-stars-fill"></i>'
                : '<i class="bi bi-sun-fill"></i>';

            modeToggleBtn.addEventListener('click', toggleDarkMode);
            navContainer.appendChild(modeToggleBtn);

            header.appendChild(navContainer);

            // User ID
            const userIdP = document.createElement('p');
            userIdP.className = "small text-muted mt-3 mt-md-0 text-md-end w-100 w-md-auto mb-0";
            userIdP.textContent = `Local User Context: ${userId}`;
            header.appendChild(userIdP);

            return header;
        }

        // --- Render Tracker View (The Quadrant Dashboard) ---
        function renderTrackerView() {
            const div = document.createElement('div');
            div.className = "d-flex flex-column gap-5";

            // 1. Calculate Overall "Wholeness" (Mandala Progress)
            let totalScheduled = 0;
            let totalCompleted = 0;

            // Sort modules: Mind (UL), Body (UR), Shadow (LL), Spirit (LR)
            const quadrantOrder = { 'mind': 1, 'body': 2, 'shadow': 3, 'spirit': 4 };
            const sortedConfig = [...state.config].sort((a, b) => (quadrantOrder[a.id] || 99) - (quadrantOrder[b.id] || 99));

            sortedConfig.forEach(module => {
                if (isModuleScheduledToday(module)) {
                    totalScheduled++;
                    if (checkModulePracticesCompleted(module, state.dailyLog)) {
                        totalCompleted++;
                    }
                }
            });

            const overallProgress = totalScheduled > 0 ? (totalCompleted / totalScheduled) : 0;
            const percentage = Math.round(overallProgress * 100);

            // SVG Circle Params
            const radius = 40;
            const circumference = 2 * Math.PI * radius; // ~251.3
            const strokeDashoffset = circumference - (overallProgress * circumference);

            // 2. Render Mandala Header
            div.innerHTML = `
                <div class="d-flex flex-column align-items-center justify-content-center position-relative py-3">
                    <!-- Cosmic Gradient Definition -->
                    <svg width="0" height="0" class="position-absolute">
                        <defs>
                            <linearGradient id="cosmosGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                                <stop offset="0%" stop-color="#4f46e5" />
                                <stop offset="50%" stop-color="#ec4899" />
                                <stop offset="100%" stop-color="#f59e0b" />
                            </linearGradient>
                        </defs>
                    </svg>

                    <!-- Mandala Ring -->
                    <div class="position-relative d-flex align-items-center justify-content-center" style="width: 120px; height: 120px;">
                        <svg class="mandala-ring w-100 h-100" viewBox="0 0 100 100">
                            <!-- Track -->
                            <circle class="mandala-circle-bg" cx="50" cy="50" r="${radius}"></circle>
                            <!-- Progress -->
                            <circle 
                                class="mandala-circle-progress" 
                                cx="50" cy="50" r="${radius}"
                                style="stroke-dashoffset: ${strokeDashoffset};"
                            ></circle>
                        </svg>
                        
                        <!-- Center Label -->
                        <div class="position-absolute text-center" style="z-index: 5;">
                            <div class="h3 fw-bold mb-0 lh-1 tracking-tight" style="background: linear-gradient(135deg, #1e293b, #475569); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">${percentage}%</div>
                            <div class="text-uppercase fw-bold text-body-tertiary" style="font-size: 0.6rem; letter-spacing: 0.1em;">Wholeness</div>
                        </div>
                    </div>
                    
                    <div class="mt-3 text-center">
                        <h2 class="h5 fw-bold text-body mb-0">Daily Practice</h2>
                        <span class="badge rounded-pill bg-body-secondary text-body px-3 py-1 fw-normal small font-monospace border border-secondary-subtle mt-2">
                            ${getTodayDateKey()}
                        </span>
                    </div>
                </div>
            `;

            const grid = document.createElement('div');
            // Desktop: 2 columns (Quadrants). Mobile: 1 column.
            grid.className = "row g-4";
            let modulesShown = 0;

            sortedConfig.forEach(module => {
                if (isModuleScheduledToday(module)) {
                    grid.appendChild(createPracticeCard(module));
                    modulesShown++;
                }
            });

            if (modulesShown === 0) {
                grid.innerHTML = `<div class="col-12">
                    <div class="alert glass-panel d-flex align-items-center justify-content-center py-5">
                       <div class="text-center">
                            <i class="bi bi-cup-hot fs-1 text-secondary mb-3"></i>
                            <h4 class="h6 text-body">Rest & Integration Day</h4>
                            <p class="small text-body-secondary mb-0">"The pause is as important as the breath."</p>
                       </div>
                    </div>
                </div>`;
            }

            div.appendChild(grid);
            return div;
        }

        function createPracticeCard(module) {
            const moduleCompleted = checkModulePracticesCompleted(module, state.dailyLog);
            const isChooseOne = module.frequency.rule === 'choose_one';

            // Calculate Module Progress for Mini-Ring
            const scheduledPractices = module.practices.filter(p => isPracticeScheduledToday(p));
            const completedCount = scheduledPractices.filter(p => state.dailyLog[`${module.id}_${p.id}`] === 'completed').length;
            const progress = scheduledPractices.length > 0 ? (completedCount / scheduledPractices.length) : 0;

            // Mini Ring Params (r=9, circ~56.5)
            const r = 9;
            const circ = 2 * Math.PI * r;
            const offset = circ - (progress * circ);
            const strokeColor = moduleCompleted ? 'var(--bs-success)' : `var(--mod-${module.id})`;

            const col = document.createElement('div');
            col.className = 'col-12 col-md-6'; // 2 Column Grid for Quadrant feel

            const card = document.createElement('div');
            // Holon Card classes + Integrated Glow
            card.className = `card holon-card h-100 ${moduleCompleted ? 'integrated' : ''}`;

            // We set the CSS variable for the accent color on the card itself for the glow logic
            card.style.setProperty('--mod-color-rgb', module.id === 'body' ? '231, 111, 81' :
                module.id === 'mind' ? '42, 157, 143' :
                    module.id === 'spirit' ? '165, 148, 249' : '16, 185, 129'); // Shadow is Emerald

            card.style.borderLeft = `4px solid var(--mod-${module.id})`;

            const headerBg = moduleCompleted ? 'bg-success-subtle text-success-emphasis' : 'bg-transparent';
            const iconColorClass = `accent-${module.id}`;

            const completionText = isChooseOne
                ? 'Complete <strong>ONE</strong> to transcend.'
                : 'Complete <strong>ALL</strong> to integrate.';

            card.innerHTML = `
                <div class="card-header ${headerBg} d-flex justify-content-between align-items-center border-bottom-0 pt-4 pb-2 px-4 bg-transparent">
                    <h5 class="card-title mb-0 d-flex align-items-center">
                        <span class="fs-4 me-3 ${iconColorClass}">${module.icon}</span> 
                        <span class="fw-bold tracking-tight">${module.name}</span>
                    </h5>
                    
                    <div class="d-flex align-items-center gap-2">
                        <!-- Mini Circular Progress -->
                         <div class="position-relative d-flex align-items-center justify-content-center" style="width: 24px; height: 24px;">
                            <svg class="w-100 h-100" style="transform: rotate(-90deg);">
                                <circle cx="12" cy="12" r="${r}" fill="none" stroke="currentColor" stroke-opacity="0.2" stroke-width="2.5"></circle>
                                <circle cx="12" cy="12" r="${r}" fill="none" stroke="${strokeColor}" stroke-width="2.5" stroke-linecap="round"
                                    style="stroke-dasharray: ${circ}; stroke-dashoffset: ${offset}; transition: stroke-dashoffset 0.5s ease;"></circle>
                            </svg>
                        </div>
                        ${moduleCompleted ? '<span class="badge bg-success rounded-pill px-2 shadow-sm" style="font-size: 0.6rem;">INTEGRATED</span>' : ''}
                    </div>
                </div>
                <div class="card-body px-4 pb-4">
                    <p class="card-text small text-body-secondary mb-4 opacity-75">${completionText}</p>
                    <div class="list-group list-group-flush rounded-4 overflow-hidden shadow-none gap-2" id="practices-list-${module.id}"></div>
                </div>
            `;

            const listGroup = card.querySelector(`#practices-list-${module.id}`);

            if (scheduledPractices.length === 0) {
                listGroup.innerHTML = `<div class="text-center text-body-tertiary small fst-italic py-2">No practices mapped for this timeline.</div>`;
            }

            scheduledPractices.forEach(practice => {
                const isCompleted = state.dailyLog[`${module.id}_${practice.id}`] === 'completed';

                const item = document.createElement('button');
                item.type = 'button';
                // Glassy list items
                item.className = `list-group-item list-group-item-action d-flex align-items-center gap-3 py-3 border-0 rounded-3 mb-1 transition-all ${isCompleted ? 'bg-success-subtle text-success text-decoration-line-through opacity-75' : 'bg-body-tertiary bg-opacity-50 hover-bg-body-secondary'}`;

                item.addEventListener('click', () => togglePractice(module.id, practice.id, !isCompleted));

                item.innerHTML = `
                   <div class="d-flex align-items-center justify-content-center rounded-circle flex-shrink-0 border ${isCompleted ? 'border-success bg-success text-white' : 'border-secondary bg-transparent'}" style="width: 24px; height: 24px; transition: all 0.2s;">
                        ${isCompleted ? '<i class="bi bi-check small"></i>' : ''}
                    </div>
                    <span class="mb-0 flex-grow-1 fw-medium ${isCompleted ? '' : 'text-body'}">${practice.name}</span>
                `;
                listGroup.appendChild(item);
            });

            col.appendChild(card);
            return col;
        }

        // --- Render Config View (UPDATED) ---
        // --- Render Config View (The Architect View) ---
        function renderConfigView() {
            const div = document.createElement('div');
            div.className = "d-flex flex-column gap-4";

            div.innerHTML = `
                <div class="mb-2">
                    <h2 class="h5 fw-bold text-body">Design Your Integral Practice</h2>
                    <p class="small text-body-secondary">Architect your own consciousness. Add modules and practices to build your unique Holarchical map.</p>
                </div>

                <form id="add-module-form" class="glass-panel p-4 pb-5 border-primary-subtle shadow-sm bg-gradient-primary-subtle position-relative overflow-hidden">
                     <div class="position-absolute top-0 start-0 w-100 h-100 opacity-10" style="background: radial-gradient(circle at 10% 10%, var(--integral-teal-light), transparent 70%); pointer-events: none;"></div>
                    <h5 class="card-title text-primary fw-bold mb-3 d-flex align-items-center gap-2"><i class="bi bi-plus-circle"></i> Add New Module</h5>
                    <div class="input-group input-group-lg shadow-sm">
                        <input
                            type="text"
                            id="new-module-name"
                            value="${state.newModuleName}"
                            placeholder="Module Name (e.g., 'Work Mastery')"
                            class="form-control border-0"
                            style="background: rgba(255,255,255,0.9);"
                        />
                        <button type="submit" class="btn btn-primary fw-bold px-4">
                            Initialize
                        </button>
                    </div>
                </form>

                <div id="module-list" class="d-flex flex-column gap-4"></div>
            `;

            const form = div.querySelector('#add-module-form');
            form.addEventListener('submit', handleAddModule);
            const input = div.querySelector('#new-module-name');
            input.addEventListener('input', (e) => {
                state.newModuleName = e.target.value;
            });


            const moduleListContainer = div.querySelector('#module-list');

            state.config.forEach(module => {
                const moduleDiv = document.createElement('div');
                // Holon card style for config modules
                moduleDiv.className = "card holon-card shadow-sm";
                moduleDiv.style.borderLeft = `4px solid var(--mod-${module.id})`;

                const currentRule = module.frequency.rule;
                const currentDays = module.frequency.days || [];

                // Build the Day Selection interface if the rule is 'specific_days'
                const daySelectionHtml = currentRule === 'specific_days' ? `
                    <div class="mt-3">
                        <label class="form-label small fw-semibold text-body-secondary text-uppercase tracking-wider" style="font-size: 0.7rem;">Active Days</label>
                        <div class="d-flex flex-wrap gap-2">
                            ${WEEK_DAYS.map(day => `
                                <input 
                                    type="checkbox" 
                                    class="btn-check day-selector" 
                                    id="btn-check-${module.id}-${day.key}" 
                                    autocomplete="off"
                                    data-module-id="${module.id}" 
                                    data-day-key="${day.key}"
                                    ${currentDays.includes(day.key) ? 'checked' : ''}
                                >
                                <label class="btn btn-outline-primary btn-sm rounded-pill px-3" for="btn-check-${module.id}-${day.key}">${day.name.substring(0, 3)}</label>
                            `).join('')}
                        </div>
                    </div>
                ` : '';


                moduleDiv.innerHTML = `
                    <div class="card-header bg-transparent d-flex justify-content-between align-items-center py-3 border-bottom-0">
                        <h4 class="h5 fw-bold mb-0 d-flex align-items-center text-body">
                            <span class="me-3 fs-4 accent-${module.id}">${module.icon}</span> 
                            ${module.name}
                        </h4>
                        ${module.custom ? `<button data-module-id="${module.id}" class="remove-module-btn btn btn-outline-danger btn-sm rounded-pill px-3">
                            <i class="bi bi-trash me-1"></i> Remove
                        </button>` : ''}
                    </div>

                    <div class="card-body pt-0">
                        <div class="mb-4 p-4 bg-body-tertiary bg-opacity-50 rounded-4 border border-white">
                            <label class="form-label small fw-semibold text-body-secondary text-uppercase tracking-wider" style="font-size: 0.7rem;">Completion Rule</label>
                            <div class="d-flex flex-column gap-2">
                                <select 
                                    class="form-select module-rule-selector border-0 shadow-sm"
                                    data-module-id="${module.id}"
                                >
                                    <option value="all" ${currentRule === 'all' ? 'selected' : ''}>Complete ALL Practices (Daily)</option>
                                    <option value="choose_one" ${currentRule === 'choose_one' ? 'selected' : ''}>Complete ONE Practice (Daily)</option>
                                    <option value="specific_days" ${currentRule === 'specific_days' ? 'selected' : ''}>Specific Days (Custom Frequency)</option>
                                </select>
                                
                                ${daySelectionHtml}
                            </div>
                        </div>

                        <ul class="list-group list-group-flush mb-4 rounded-4 overflow-hidden shadow-none gap-2 border-0 bg-transparent">
                            ${module.practices.map(practice => {
                    const pDays = (practice.frequency && practice.frequency.days) || [];
                    const isScheduled = pDays.length > 0;

                    return `
                                <li key="${practice.id}" class="list-group-item d-flex flex-column gap-2 p-3 border-0 bg-body-tertiary bg-opacity-25 mb-1 rounded-3">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <span class="fw-semibold text-body">${practice.name}</span>
                                        <button data-module-id="${module.id}" data-practice-id="${practice.id}" class="remove-practice-btn btn btn-sm btn-icon text-danger-emphasis hover-text-danger p-1 rounded-circle hover-bg-danger-subtle transition-all">
                                            <i class="bi bi-x-lg"></i>
                                        </button>
                                    </div>
                                    
                                    <div class="d-flex align-items-center gap-3">
                                        <span class="small text-body-secondary fw-medium" style="font-size: 0.7rem;">SCHEDULE</span>
                                        <div class="btn-group btn-group-sm" role="group">
                                            ${WEEK_DAYS.map(day => `
                                                <input 
                                                    type="checkbox" 
                                                    class="btn-check practice-day-selector"
                                                    id="p-day-${module.id}-${practice.id}-${day.key}"
                                                    autocomplete="off"
                                                    data-module-id="${module.id}" 
                                                    data-practice-id="${practice.id}"
                                                    data-day-key="${day.key}"
                                                    ${pDays.includes(day.key) ? 'checked' : ''}
                                                >
                                                <label class="btn btn-outline-secondary border-0 py-0 px-2 small" style="font-size: 0.7rem;" for="p-day-${module.id}-${practice.id}-${day.key}">
                                                    ${day.name.charAt(0)}
                                                </label>
                                            `).join('')}
                                        </div>
                                    </div>
                                    ${isScheduled ? '<div class="form-text mt-0 text-primary small" style="font-size: 0.7rem;"><i class="bi bi-calendar-check me-1"></i>Custom Schedule Active</div>' : ''}
                                </li>
                            `}).join('')}
                        </ul>

                        <form data-module-id="${module.id}" class="add-practice-form input-group shadow-sm">
                            <input
                                type="text"
                                data-module-id="${module.id}"
                                value="${state.newPracticeTexts[module.id] || ''}"
                                placeholder="New practice..."
                                class="practice-input form-control border-0 bg-white"
                            />
                            <button
                                type="submit"
                                class="btn btn-light border-0 text-primary fw-medium"
                            >
                                <i class="bi bi-plus-lg"></i> Add
                            </button>
                        </form>
                    </div>
                `;

                moduleListContainer.appendChild(moduleDiv);
            });

            // Setup event listeners for the dynamically created elements

            // Rule Selector
            div.querySelectorAll('.module-rule-selector').forEach(select => {
                select.addEventListener('change', (e) => {
                    handleUpdateModuleFrequencyRule(e.target.dataset.moduleId, e.target.value);
                });
            });

            // Day Selector Checkboxes
            div.querySelectorAll('.day-selector').forEach(checkbox => {
                checkbox.addEventListener('change', (e) => {
                    handleUpdateModuleFrequencyDays(e.target.dataset.moduleId, e.target.dataset.dayKey, e.target.checked);
                });
            });

            // Day Selector Checkboxes (Practice Level)
            div.querySelectorAll('.practice-day-selector').forEach(checkbox => {
                checkbox.addEventListener('change', (e) => {
                    handleUpdatePracticeFrequencyDays(e.target.dataset.moduleId, e.target.dataset.practiceId, e.target.dataset.dayKey, e.target.checked);
                });
            });

            // Remove Module, Remove Practice, Add Practice Form, Practice Input handlers (unchanged)
            div.querySelectorAll('.remove-module-btn').forEach(btn => {
                btn.addEventListener('click', (e) => handleRemoveModule(e.target.dataset.moduleId));
            });
            // ... (other handlers)
            div.querySelectorAll('.remove-practice-btn').forEach(btn => {
                btn.addEventListener('click', (e) => handleRemovePractice(e.target.dataset.moduleId, e.target.dataset.practiceId));
            });

            div.querySelectorAll('.add-practice-form').forEach(form => {
                form.addEventListener('submit', (e) => handleAddPractice(e, form.dataset.moduleId));
            });

            div.querySelectorAll('.practice-input').forEach(input => {
                input.addEventListener('input', (e) => {
                    const moduleId = e.target.dataset.moduleId;
                    state.newPracticeTexts = { ...state.newPracticeTexts, [moduleId]: e.target.value };
                });
            });

            return div;
        }

        // --- Render History View (Integral Timeline) ---
        function renderHistoryView() {
            const div = document.createElement('div');
            div.className = "d-flex flex-column gap-4";

            div.innerHTML = `
                <div class="mb-2">
                    <h2 class="h5 fw-bold text-body">Evolutionary History</h2>
                    <p class="small text-body-secondary">Track the unfoldment of your practice over time.</p>
                </div>
            `;

            const historyContainer = document.createElement('div');
            historyContainer.className = "d-flex flex-column gap-5";

            const logDates = Object.keys(state.allLogs).sort();

            if (logDates.length === 0) {
                historyContainer.innerHTML = `
                    <div class="glass-panel p-5 text-center">
                        <i class="bi bi-stars fs-1 text-warning mb-3"></i>
                        <p class="lead">Your journey begins now.</p>
                        <p class="small text-body-secondary">Complete practices in the Daily Tracker to see your history unfold.</p>
                    </div>
                `;
            } else {
                const logsByWeek = {};
                for (const dateKey of logDates) {
                    const weekStartKey = getWeekStartKey(dateKey);
                    if (!logsByWeek[weekStartKey]) {
                        logsByWeek[weekStartKey] = [];
                    }
                    logsByWeek[weekStartKey].push(dateKey);
                }

                const weekKeys = Object.keys(logsByWeek).sort().reverse();
                const todayKey = getTodayDateKey();

                weekKeys.forEach(weekStartKey => {
                    const weekDiv = document.createElement('div');
                    weekDiv.className = "glass-panel p-4";

                    const weekHeader = document.createElement('div');
                    weekHeader.className = "d-flex justify-content-between align-items-center mb-4 border-bottom border-secondary-subtle pb-2";

                    const title = document.createElement('h3');
                    title.className = "h6 fw-bold text-primary text-uppercase tracking-wider mb-0";
                    title.textContent = `Week of ${formatWeekRange(weekStartKey)}`;

                    const exportBtn = document.createElement('button');
                    exportBtn.textContent = "Export Log";
                    exportBtn.className = "btn btn-sm btn-link text-body-secondary text-decoration-none";
                    exportBtn.addEventListener('click', () => handleExportWeek(weekStartKey));

                    weekHeader.appendChild(title);
                    weekHeader.appendChild(exportBtn);

                    weekDiv.appendChild(weekHeader);

                    const dailyLogGrid = document.createElement('div');
                    dailyLogGrid.className = "row g-3";

                    const weekLogs = logsByWeek[weekStartKey].sort().reverse();

                    weekLogs.forEach(dateKey => {
                        const logEntry = state.allLogs[dateKey];
                        const dateObj = new Date(dateKey + 'T00:00:00');
                        const dayOfWeek = dateObj.toLocaleDateString('en-US', { weekday: 'short' });

                        let completedModulesCount = 0;
                        let scheduledModulesCount = 0;

                        state.config.forEach(module => {
                            const status = isModuleCompleted(module, logEntry.practices, dateKey);
                            if (status !== 'N/A') {
                                scheduledModulesCount++;
                                if (status === true) completedModulesCount++;
                            }
                        });


                        const completionPercentage = scheduledModulesCount > 0 ? Math.round((completedModulesCount / scheduledModulesCount) * 100) : 0;
                        const isToday = dateKey === todayKey;

                        const col = document.createElement('div');
                        col.className = 'col-6 col-md-4 col-lg-3';

                        const dayCard = document.createElement('div');
                        dayCard.className = `card h-100 cursor-pointer border-0 shadow-sm transition-all ${isToday ? 'bg-primary-subtle bg-opacity-25 ring-2 ring-primary' : 'bg-body-tertiary bg-opacity-50'}`;
                        dayCard.style.borderRadius = "1rem";

                        dayCard.addEventListener('click', () => handleDayLogClick(dateKey));

                        // Dynamic color based on percentage
                        let barColor = "bg-secondary";
                        if (completionPercentage >= 100) barColor = "bg-success";
                        else if (completionPercentage >= 75) barColor = "bg-info";
                        else if (completionPercentage >= 50) barColor = "bg-warning";

                        dayCard.innerHTML = `
                            <div class="card-body p-3 d-flex flex-column justify-content-between h-100">
                                <div class="mb-2">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <span class="fw-bold small text-body">${dayOfWeek}</span>
                                        <span class="badge rounded-pill bg-body text-body-secondary border px-2" style="font-size: 0.6rem;">${dateObj.getDate()}</span>
                                    </div>
                                    <div class="small font-monospace text-body-secondary opacity-50" style="font-size: 0.65rem;">${dateKey}</div>
                                </div>
                                <div>
                                    <div class="progress mb-2 bg-white bg-opacity-50" style="height: 6px; border-radius: 4px;">
                                        <div class="progress-bar ${barColor}" role="progressbar" style="width: ${completionPercentage}%"></div>
                                    </div>
                                    <div class="d-flex justify-content-between align-items-end" style="line-height: 1;">
                                        <span class="fw-bold ${completionPercentage === 100 ? 'text-success' : 'text-primary'}" style="font-size: 1.1rem;">${completionPercentage}%</span>
                                    </div>
                                </div>
                            </div>
                        `;
                        col.appendChild(dayCard);
                        dailyLogGrid.appendChild(col);
                    });

                    weekDiv.appendChild(dailyLogGrid);
                    historyContainer.appendChild(weekDiv);
                });
            }

            div.appendChild(historyContainer);

            if (state.selectedLogDate) {
                const modal = createLogDetailsModal(state.selectedLogDate);
                div.appendChild(modal);
            }

            return div;
        }

        function createLogDetailsModal(dateKey) {
            const logEntry = state.allLogs[dateKey] || { practices: {} };

            const backdrop = document.createElement('div');
            backdrop.className = "modal-backdrop fade show";
            backdrop.style.backdropFilter = "blur(5px)";

            const modal = document.createElement('div');
            modal.className = "modal fade show d-block";
            modal.tabIndex = -1;
            modal.setAttribute('role', 'dialog');

            modal.addEventListener('click', (e) => {
                if (e.target === modal) handleCloseModal();
            });

            const dialog = document.createElement('div');
            dialog.className = "modal-dialog modal-dialog-centered modal-lg modal-dialog-scrollable";

            const content = document.createElement('div');
            content.className = "modal-content glass-panel border-0 shadow-lg overflow-hidden";
            content.style.backgroundColor = "var(--bs-body-bg)";

            content.innerHTML = `
                <div class="modal-header border-bottom-0 pb-0">
                    <div>
                        <h5 class="modal-title fw-bold">Daily Integration Log</h5>
                        <p class="small text-primary fw-medium mb-0">${new Date(dateKey + 'T00:00:00').toDateString()}</p>
                    </div>
                    <button type="button" class="btn-close" id="close-modal-btn" aria-label="Close"></button>
                </div>
                <div class="modal-body pt-4">
                    <div class="d-flex flex-column gap-3" id="modal-practices-container"></div>
                </div>
            `;

            const practicesContainer = content.querySelector('#modal-practices-container');

            state.config.forEach(module => {
                const status = isModuleCompleted(module, logEntry.practices, dateKey);
                if (status === 'N/A') return;

                const completed = status === true;
                const scheduledPractices = module.practices.filter(p => isPracticeScheduledToday(p, dateKey));

                const moduleDiv = document.createElement('div');
                moduleDiv.className = `p-3 rounded-4 border ${completed ? "border-success bg-success-subtle bg-opacity-10" : "border-secondary-subtle bg-body-tertiary bg-opacity-25"}`;

                moduleDiv.innerHTML = `
                    <div class="d-flex align-items-center gap-3 mb-3">
                        <div class="fs-4 lh-1 accent-${module.id}">${module.icon}</div>
                        <h5 class="mb-0 fw-bold fs-6 ${completed ? "text-success-emphasis" : "text-body"}">${module.name}</h5>
                    </div>
                    <ul class="list-unstyled ms-2 mb-0 d-flex flex-column gap-2">
                        ${scheduledPractices.map(p => {
                    const pDone = logEntry.practices[`${module.id}_${p.id}`] === 'completed';
                    return `
                                <li class="small d-flex align-items-center gap-2 ${pDone ? "text-success fw-medium" : "text-body-secondary"}">
                                    <span class="d-inline-flex align-items-center justify-content-center border rounded-circle ${pDone ? "bg-success border-success text-white" : "border-secondary-subtle"}" style="width: 18px; height: 18px; font-size: 10px;">
                                        ${pDone ? '<i class="bi bi-check" style="font-size: 12px; margin-top: 1px;"></i>' : ""}
                                    </span>
                                    ${p.name}
                                </li>
                             `
                }).join('')}
                    </ul>
                  `;
                practicesContainer.appendChild(moduleDiv);
            });

            if (practicesContainer.innerHTML === "") {
                practicesContainer.innerHTML = "<p class='text-muted fst-italic text-center my-4'>No modules were active on this day.</p>";
            }

            const closeBtn = content.querySelector('#close-modal-btn');
            closeBtn.addEventListener('click', handleCloseModal);

            dialog.appendChild(content);
            modal.appendChild(dialog);

            const wrapper = document.createElement('div');
            wrapper.appendChild(backdrop);
            wrapper.appendChild(modal);

            return wrapper;
        }

        // --- Main Render Function ---

        function renderApp() {
            const app = document.getElementById('app');
            app.innerHTML = '';

            if (state.loading) {
                app.appendChild(renderLoadingState());
                return;
            }

            if (state.error) {
                app.appendChild(renderHeader());
                app.appendChild(renderErrorState());
                return;
            }

            app.appendChild(renderHeader());

            if (state.view === 'tracker') {
                app.appendChild(renderTrackerView());
            } else if (state.view === 'config') {
                app.appendChild(renderConfigView());
            } else if (state.view === 'history') {
                app.appendChild(renderHistoryView());
            }
        }

        // --- Initialization ---

        initApp();

    </script>
</body>

</html>