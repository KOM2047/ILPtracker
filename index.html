<!DOCTYPE html>
<html lang="en" data-mode="light">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Integral Life Practice Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <meta name="theme-color" content="#4f46e5">
    <style>
        /* Custom styles for consistency and aesthetics */
        body {
            font-family: 'Inter', sans-serif;
        }

        .form-checkbox {
            min-width: 1.25rem;
            min-height: 1.25rem;
        }

        /* Dark Mode: Ensure the body background is consistent */
        html[data-mode="dark"] body {
            background-color: #1f2937;
        }
    </style>
</head>

<body class="bg-slate-50 min-h-screen">
    <div id="app" class="max-w-6xl mx-auto p-4 sm:p-8">
        </div>

    <script type="module">
        // **CORRECTION:** Changed relative paths to absolute CDN URLs for Firebase imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // --- Global Variables (Provided by Canvas Environment) ---
        let auth = null;
        let userId = null;

        // State object replaces React's useState
        let state = {
            loading: true,
            error: '',
            config: [],
            dailyLog: {}, // Today's log (subset of allLogs)
            allLogs: {}, // All historical logs by date key
            view: 'tracker', // 'tracker', 'config', or 'history'
            newModuleName: '',
            newPracticeTexts: {}, // { moduleId: text, ... }
            darkMode: false,
            selectedLogDate: null,
            // NEW: Temporary state for day selection in config view
            tempFrequencyDays: {} 
        };

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'ilp-default-app';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? JSON.parse(__initial_auth_token) : null;

        const getTodayDateKey = () => new Date().toISOString().split('T')[0];

        // Helper: Get today's day key (used for frequency check)
        const getTodayDayKey = () => ['sun', 'mon', 'tue', 'wed', 'thu', 'fri', 'sat'][new Date().getDay()];

        const CORE_MODULES = [
            // UPDATED: Changed 'completionRule' to 'frequency' object
            { id: 'body', name: 'Body', icon: '純', frequency: { rule: 'all', days: [] }, practices: ['Yoga', 'Cardio', 'Nutrition'] },
            { id: 'mind', name: 'Mind', icon: 'ｧ', frequency: { rule: 'all', days: [] }, practices: ['Study', 'Concentration', 'Journaling'] },
            { id: 'spirit', name: 'Spirit', icon: '笨ｨ', frequency: { rule: 'all', days: [] }, practices: ['Meditation', 'Contemplation'] },
            { id: 'shadow', name: 'Shadow', icon: '倦', frequency: { rule: 'all', days: [] }, practices: ['Inquiry', 'Therapy'] },
        ];
        
        const WEEK_DAYS = [
            { key: 'mon', name: 'Monday' },
            { key: 'tue', name: 'Tuesday' },
            { key: 'wed', name: 'Wednesday' },
            { key: 'thu', name: 'Thursday' },
            { key: 'fri', name: 'Friday' },
            { key: 'sat', name: 'Saturday' },
            { key: 'sun', name: 'Sunday' },
        ];


        // --- Dark Mode Logic (omitted for brevity, assumed unchanged) ---
        function getLocalDarkModeKey() { return `ilp_dark_mode`; }
        function loadDarkModePreference() {
            const isDark = localStorage.getItem(getLocalDarkModeKey()) === 'true';
            state.darkMode = isDark;
            applyDarkMode(isDark);
        }

        function saveDarkModePreference(isDark) {
            localStorage.setItem(getLocalDarkModeKey(), isDark ? 'true' : 'false');
            applyDarkMode(isDark);
        }

        function applyDarkMode(isDark) {
            const htmlEl = document.documentElement;
            if (isDark) {
                htmlEl.classList.add('dark');
                htmlEl.setAttribute('data-mode', 'dark');
            } else {
                htmlEl.classList.remove('dark');
                htmlEl.setAttribute('data-mode', 'light');
            }
        }

        function toggleDarkMode() {
            const newMode = !state.darkMode;
            setState({ darkMode: newMode });
            saveDarkModePreference(newMode);
        }

        // --- Date/Week Helper Functions (omitted for brevity, assumed unchanged) ---

        /**
         * Calculates the Sunday (start) of the week for a given date key.
         * @param {string} dateKey - 'YYYY-MM-DD'
         * @returns {string} - 'YYYY-MM-DD' for Sunday
         */
        function getWeekStartKey(dateKey) {
            const date = new Date(dateKey + 'T00:00:00');
            const day = date.getDay(); // 0 is Sunday
            const weekStart = new Date(date);
            weekStart.setDate(date.getDate() - day);
            return weekStart.toISOString().split('T')[0];
        }

        /**
         * Formats the week range for display (Sunday - Saturday).
         * @param {string} weekStartKey - 'YYYY-MM-DD' for Sunday
         * @returns {string} - Formatted date range string
         */
        function formatWeekRange(weekStartKey) {
            const start = new Date(weekStartKey + 'T00:00:00');
            const end = new Date(start);
            end.setDate(start.getDate() + 6); // Saturday

            const startStr = start.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            const endStr = end.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });

            if (start.getFullYear() === end.getFullYear()) {
                return `${startStr} – ${end.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}`;
            }
            return `${startStr}, ${start.getFullYear()} – ${endStr}`;
        }

        // --- Core Logic Helper ---

        /**
         * Finds a module in config by its ID.
         * @param {string} moduleId 
         * @returns {Object|undefined}
         */
        function getModuleById(moduleId) {
            return state.config.find(m => m.id === moduleId);
        }

        /**
         * Determines if a module is scheduled for today.
         * @param {Object} module 
         * @param {string} dateKey - Optional date key (YYYY-MM-DD) for historical check
         * @returns {boolean}
         */
        function isModuleScheduledToday(module, dateKey = null) {
            const dayKey = dateKey ? ['sun', 'mon', 'tue', 'wed', 'thu', 'fri', 'sat'][new Date(dateKey + 'T00:00:00').getDay()] : getTodayDayKey();
            const freq = module.frequency;

            if (freq.rule === 'specific_days' && freq.days && freq.days.length > 0) {
                return freq.days.includes(dayKey);
            }
            // If rule is 'all', 'choose_one', or 'specific_days' with no days set, it defaults to daily.
            return true;
        }

        /**
         * Determines if a module is completed based on its practices.
         * NOTE: This function does NOT check scheduling.
         * @param {Object} module 
         * @param {Object} dailyLog 
         * @returns {boolean}
         */
        function checkModulePracticesCompleted(module, dailyLog) {
            if (!module.practices || module.practices.length === 0) return true;

            const isPracticeCompleted = (p) => dailyLog[`${module.id}_${p.id}`] === 'completed';

            if (module.frequency.rule === 'choose_one') {
                return module.practices.some(isPracticeCompleted);
            } else { // 'all' (default and specific_days combined)
                return module.practices.every(isPracticeCompleted);
            }
        }
        
        /**
         * Determines if a module is completed based on its practices AND scheduling for today.
         * @param {Object} module 
         * @param {Object} dailyLog 
         * @param {string} dateKey - Date key for which the log applies (used for scheduling check)
         * @returns {boolean|'N/A'} - true/false or 'N/A' if not scheduled
         */
        function isModuleCompleted(module, dailyLog, dateKey = null)
        {
            if (!isModuleScheduledToday(module, dateKey)) {
                return 'N/A';
            }
            return checkModulePracticesCompleted(module, dailyLog);
        }

        // --- State Management and Renderer ---

        // Central function to update state and trigger a re-render
        function setState(updates)
        {
            // Shallow merge updates into the global state
            Object.assign(state, updates);
            renderApp();
        }

        // --- Auth/Listeners (Simplified for Local Storage) ---

        async function initApp()
        {
            loadDarkModePreference();

            try
            {
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);

                onAuthStateChanged(auth, async (user) =>
                {
                    if (user)
                    {
                        userId = user.uid;
                        setState({ loading: false });
                        loadConfig();
                        loadDailyLog();
                    } else
                    {
                        try
                        {
                            if (initialAuthToken)
                            {
                                await signInWithCustomToken(auth, initialAuthToken);
                            } else
                            {
                                await signInAnonymously(auth);
                            }
                        } catch (e)
                        {
                            console.error('Auth error during sign-in attempt. Using fallback ID.', e);
                            userId = 'local-user-session';
                        }
                    }
                });

            } catch (e)
            {
                console.error("Initialization failed. Using local fallback.", e);
                userId = 'local-user-session';
                setState({ loading: false });
                loadConfig();
                loadDailyLog();
            }
        }

        function getLocalConfigKey() { return `ilp_config_${userId}`; }
        function getLocalAllLogsKey() { return `ilp_all_logs_${userId}`; }

        // --- Data Loaders (Local Storage Readers) ---

        function loadConfig()
        {
            const configKey = getLocalConfigKey();
            const storedConfig = localStorage.getItem(configKey);

            if (storedConfig)
            {
                try
                {
                    const parsedConfig = JSON.parse(storedConfig).modules;
                    // MIGRATION/Normalization: ensure all modules have the new frequency object
                    const normalizedConfig = parsedConfig.map(m => ({
                        ...m,
                        frequency: m.frequency || { rule: m.completionRule || 'all', days: [] }
                    }));
                    setState({ config: normalizedConfig });
                } catch (e)
                {
                    console.error("Error parsing stored config:", e);
                    initializeDefaultConfig();
                }
            } else if (state.config.length === 0)
            {
                initializeDefaultConfig();
            }
        }

        function initializeDefaultConfig()
        {
            // Initialize with default modules if no config exists
            const initialConfig = CORE_MODULES.map(m => ({
                ...m,
                practices: m.practices.map(p => ({ id: p.toLowerCase().replace(/\s/g, '_'), name: p, custom: false }))
            }));

            setState({ config: initialConfig });
            saveConfig(initialConfig);
        }


        function loadDailyLog()
        {
            const todayKey = getTodayDateKey();
            const logKey = getLocalAllLogsKey();
            const storedLogs = localStorage.getItem(logKey);

            let allLogs = {};
            if (storedLogs)
            {
                try
                {
                    allLogs = JSON.parse(storedLogs).logs || {};
                } catch (e)
                {
                    console.error("Error parsing stored logs:", e);
                }
            }

            const todayLog = allLogs[todayKey] ? allLogs[todayKey].practices : {};

            setState({
                dailyLog: todayLog,
                allLogs: allLogs
            });
        }

        // --- Data Handlers (Local Storage Writers) ---

        function saveConfig(newConfig)
        {
            if (!userId) return;
            const configKey = getLocalConfigKey();

            try
            {
                localStorage.setItem(configKey, JSON.stringify({ modules: newConfig, updatedAt: new Date().toISOString() }));
            } catch (e)
            {
                console.error("Error saving config to localStorage:", e);
                setState({ error: "Failed to save configuration locally." });
            }
        }

        function togglePractice(moduleId, practiceId, isChecked)
        {
            if (!userId) return;
            const todayKey = getTodayDateKey();
            const logKey = getLocalAllLogsKey();

            // 1. Update today's specific log state (dailyLog)
            const newDailyLog = {
                ...state.dailyLog,
                [`${moduleId}_${practiceId}`]: isChecked ? 'completed' : 'pending',
            };

            // 2. Update the full history object (allLogs)
            const updatedAllLogs = {
                ...state.allLogs,
                [todayKey]: {
                    date: todayKey,
                    practices: newDailyLog,
                    updatedAt: new Date().toISOString()
                }
            };

            try
            {
                setState({
                    dailyLog: newDailyLog,
                    allLogs: updatedAllLogs
                });

                localStorage.setItem(logKey, JSON.stringify({
                    logs: updatedAllLogs,
                    updatedAt: new Date().toISOString()
                }));
            } catch (e)
            {
                console.error("Error updating daily log in localStorage:", e);
                setState({ error: "Failed to update habit tracker locally." });
            }
        }

        // --- Config UI Handlers (UPDATED) ---

        function handleUpdateModuleFrequencyRule(moduleId, rule)
        {
            const newConfig = state.config.map(module =>
            {
                if (module.id === moduleId)
                {
                    // Preserve days if switching back and forth from specific_days
                    const days = (module.frequency.days || []).slice();
                    return { ...module, frequency: { rule: rule, days: days } };
                }
                return module;
            });
            setState({ config: newConfig });
            saveConfig(newConfig);
        }
        
        function handleUpdateModuleFrequencyDays(moduleId, dayKey, isChecked) {
            const newConfig = state.config.map(module =>
            {
                if (module.id === moduleId)
                {
                    let newDays = (module.frequency.days || []).slice();
                    if (isChecked && !newDays.includes(dayKey)) {
                        newDays.push(dayKey);
                    } else if (!isChecked && newDays.includes(dayKey)) {
                        newDays = newDays.filter(day => day !== dayKey);
                    }
                    // Sort days for consistency (Mon-Sun order)
                    const dayOrder = WEEK_DAYS.map(d => d.key);
                    newDays.sort((a, b) => dayOrder.indexOf(a) - dayOrder.indexOf(b));

                    return { ...module, frequency: { ...module.frequency, days: newDays } };
                }
                return module;
            });
            setState({ config: newConfig });
            saveConfig(newConfig);
        }

        function handleAddModule(e)
        {
            e.preventDefault();
            const moduleName = state.newModuleName.trim();
            if (!moduleName) return;

            const newId = moduleName.toLowerCase().replace(/\s/g, '_') + Date.now();
            const newModule = {
                id: newId,
                name: moduleName,
                icon: '験',
                frequency: { rule: 'all', days: [] }, // NEW DEFAULT
                practices: [],
                custom: true,
            };
            const newConfig = [...state.config, newModule];

            setState({ newModuleName: '', config: newConfig });
            saveConfig(newConfig);
        }

        function handleAddPractice(e, moduleId)
        {
            e.preventDefault();
            const practiceText = state.newPracticeTexts[moduleId] || '';

            if (!practiceText.trim()) return;

            const newConfig = state.config.map(module =>
            {
                if (module.id === moduleId)
                {
                    const newPractice = {
                        id: practiceText.trim().toLowerCase().replace(/\s/g, '_') + Date.now(),
                        name: practiceText.trim(),
                        custom: true,
                    };
                    return {
                        ...module,
                        practices: [...module.practices, newPractice]
                    };
                }
                return module;
            });

            const newPracticeTexts = { ...state.newPracticeTexts, [moduleId]: '' };
            setState({ newPracticeTexts, config: newConfig });
            saveConfig(newConfig);
        }

        function handleRemovePractice(moduleId, practiceId)
        {
            const newConfig = state.config.map(module =>
            {
                if (module.id === moduleId)
                {
                    return {
                        ...module,
                        practices: module.practices.filter(p => p.id !== practiceId)
                    };
                }
                return module;
            });
            setState({ config: newConfig });
            saveConfig(newConfig);
        }

        function handleRemoveModule(moduleId)
        {
            const newConfig = state.config.filter(m => m.id !== moduleId);
            setState({ config: newConfig });
            saveConfig(newConfig);
        }
        
        function handleDayLogClick(dateKey) {
            setState({ selectedLogDate: dateKey });
        }

        function handleCloseModal() {
            setState({ selectedLogDate: null });
        }


        // --- DOM Creation Utilities and Rendering ---

        // (renderLoadingState, renderErrorState, renderHeader are omitted for brevity, assumed unchanged)
        function renderLoadingState()
        {
            const div = document.createElement('div');
            div.className = "fixed inset-0 flex flex-col items-center justify-center bg-slate-50 dark:bg-gray-800 z-50";
            div.innerHTML = `
                <svg class="animate-spin h-10 w-10 text-indigo-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <p class="mt-4 text-lg font-medium text-gray-700 dark:text-gray-300">Loading your Integral Practice from local browser storage...</p>
            `;
            return div;
        }

        function renderErrorState()
        {
            const div = document.createElement('div');
            div.className = "p-4 bg-red-100 dark:bg-red-900 border border-red-400 dark:border-red-700 text-red-700 dark:text-red-300 rounded-lg shadow-md mt-4";
            div.innerHTML = `
                <h3 class="font-bold text-lg">System Error</h3>
                <p>${state.error}</p>
                <p class="text-sm mt-2">
                    If the error persists, please try reloading the page.
                    <br/>User Context: <span class="font-mono bg-red-200 dark:bg-red-800 px-1 rounded text-xs">${userId || 'N/A'}</span>
                    <br/>**Note: Data is saved to local browser storage only.**
                </p>
            `;
            return div;
        }

        function renderHeader()
        {
            const header = document.createElement('header');
            header.className = "flex flex-col sm:flex-row justify-between items-center py-4 mb-8 border-b-2 border-indigo-100 dark:border-indigo-900";

            // Title
            const h1 = document.createElement('h1');
            h1.className = "text-3xl font-extrabold text-indigo-900 dark:text-indigo-200 tracking-tight flex items-center mb-4 sm:mb-0";
            h1.innerHTML = '<span class="text-4xl mr-2">検</span> Integral Life Practice (Local)';
            header.appendChild(h1);

            // Nav Buttons Container
            const navContainer = document.createElement('div');
            navContainer.className = "flex items-center space-x-3 w-full sm:w-auto justify-between sm:justify-start";

            // Nav Buttons
            const navDiv = document.createElement('div');
            navDiv.className = "flex space-x-3";

            const createButton = (text, targetView) =>
            {
                const btn = document.createElement('button');
                btn.textContent = text;
                btn.className = `px-4 py-2 rounded-full font-semibold transition-all duration-200 ${
                    state.view === targetView
                        ? 'bg-indigo-600 text-white shadow-lg'
                        : 'bg-white text-indigo-600 border border-indigo-300 dark:bg-gray-700 dark:text-indigo-400 dark:border-indigo-900 hover:bg-indigo-50 dark:hover:bg-gray-600'
                }`;
                btn.addEventListener('click', () => setState({ view: targetView }));
                return btn;
            };

            navDiv.appendChild(createButton('Daily Tracker', 'tracker'));
            navDiv.appendChild(createButton('Design ILP', 'config'));
            navDiv.appendChild(createButton('History', 'history'));
            navContainer.appendChild(navDiv);

            // Dark Mode Toggle Button
            const modeToggleBtn = document.createElement('button');
            modeToggleBtn.className = 'p-2 rounded-full text-indigo-600 dark:text-indigo-400 bg-white dark:bg-gray-700 hover:bg-indigo-50 dark:hover:bg-gray-600 transition-colors shadow-md';
            modeToggleBtn.innerHTML = state.darkMode
                ? '<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" /></svg>'
                : '<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" /></svg>';

            modeToggleBtn.addEventListener('click', toggleDarkMode);
            navContainer.appendChild(modeToggleBtn);

            header.appendChild(navContainer);

            // User ID
            const userIdP = document.createElement('p');
            userIdP.className = "text-xs text-slate-500 dark:text-slate-400 mt-4 sm:mt-0 sm:text-right w-full sm:w-auto";
            userIdP.textContent = `Local User Context: ${userId}`;
            header.appendChild(userIdP);

            return header;
        }

        // --- Render Tracker View (UPDATED) ---
        function renderTrackerView()
        {
            const div = document.createElement('div');
            div.className = "space-y-6";

            div.innerHTML = `<h2 class="text-2xl font-extrabold text-slate-800 dark:text-slate-100">Today's ILP (${getTodayDateKey()})</h2>`;

            const grid = document.createElement('div');
            grid.className = "grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6";
            let modulesShown = 0;

            state.config.forEach(module =>
            {
                if (isModuleScheduledToday(module)) {
                    grid.appendChild(createPracticeCard(module));
                    modulesShown++;
                }
            });

            if (modulesShown === 0) {
                 grid.innerHTML = `<p class="p-4 bg-indigo-100 dark:bg-indigo-900/50 rounded-xl text-indigo-800 dark:text-indigo-300 border border-indigo-300 dark:border-indigo-700 col-span-full">
                    No modules are scheduled for today (${new Date().toLocaleDateString('en-US', { weekday: 'long' })}). Enjoy your rest day!
                </p>`;
            }

            div.appendChild(grid);
            return div;
        }

        function createPracticeCard(module)
        {
            // Note: isModuleCompleted will return true/false here because we only call it if scheduled
            const moduleCompleted = checkModulePracticesCompleted(module, state.dailyLog); 
            const isChooseOne = module.frequency.rule === 'choose_one';

            const card = document.createElement('div');
            card.className = `p-4 border-2 rounded-xl shadow-lg transition-all duration-300 ${
                moduleCompleted
                    ? 'bg-green-50 border-green-300 dark:bg-green-900 dark:border-green-700'
                    : 'bg-white border-slate-200 hover:shadow-xl dark:bg-gray-700 dark:border-gray-600 dark:hover:shadow-2xl'
            }`;

            const completionText = isChooseOne
                ? 'Complete ONE practice below to satisfy this module.'
                : 'Complete ALL practices below to satisfy this module.';

            const completionStyle = moduleCompleted ? 'text-green-600 dark:text-green-400' : 'text-slate-500 dark:text-slate-400';

            card.innerHTML = `
                <div class="flex items-center justify-between mb-3 border-b pb-2 border-indigo-100 dark:border-indigo-800">
                    <div class="flex items-center">
                        <span class="text-2xl mr-2">${module.icon}</span>
                        <h3 class="text-xl font-semibold ${
                            moduleCompleted
                                ? 'text-green-700 dark:text-green-300'
                                : 'text-indigo-700 dark:text-indigo-300'
                        }">${module.name}</h3>
                    </div>
                    <p class="text-xs font-medium ${completionStyle}">${moduleCompleted ? 'COMPLETED' : 'IN PROGRESS'}</p>
                </div>
                <p class="text-xs mb-3 ${completionStyle} italic">${completionText}</p>
                <ul class="space-y-2" id="practices-list-${module.id}"></ul>
            `;

            const ul = card.querySelector(`#practices-list-${module.id}`);

            module.practices.forEach(practice =>
            {
                const isCompleted = state.dailyLog[`${module.id}_${practice.id}`] === 'completed';

                const li = document.createElement('li');
                li.className = `flex items-center p-2 rounded-lg cursor-pointer transition-colors duration-200 ${
                    isCompleted
                        ? 'bg-green-100 text-green-800 dark:bg-green-800 dark:text-green-100'
                        : 'hover:bg-indigo-50 bg-slate-50 dark:bg-gray-600 dark:hover:bg-gray-500'
                }`;
                li.addEventListener('click', () => togglePractice(module.id, practice.id, !isCompleted));

                li.innerHTML = `
                    <input
                        type="checkbox"
                        ${isCompleted ? 'checked' : ''}
                        readonly
                        class="form-checkbox h-5 w-5 rounded transition duration-150 ease-in-out ${
                            isCompleted
                                ? 'text-green-600 border-green-500 bg-green-200 focus:ring-green-500'
                                : 'text-indigo-600 border-gray-300 dark:border-gray-500 focus:ring-indigo-500'
                        }"
                    />
                    <span class="ml-3 text-sm font-medium ${
                        isCompleted
                            ? 'line-through opacity-70'
                            : 'text-gray-800 dark:text-gray-200'
                    }">
                        ${practice.name}
                    </span>
                `;
                ul.appendChild(li);
            });

            return card;
        }

        // --- Render Config View (UPDATED) ---
        function renderConfigView()
        {
            const div = document.createElement('div');
            div.className = "space-y-8";

            div.innerHTML = `
                <h2 class="text-2xl font-extrabold text-slate-800 dark:text-slate-100">Design Your Integral Life Practice</h2>
                <p class="text-slate-600 dark:text-slate-400">Add or remove practices in your modules. This is your personal blueprint!</p>

                <form id="add-module-form" class="bg-indigo-50 dark:bg-indigo-900 p-6 rounded-xl shadow-inner border border-indigo-200 dark:border-indigo-800">
                    <h3 class="text-xl font-semibold mb-3 text-indigo-700 dark:text-indigo-300">Add a New Module (e.g., Relationships, Work)</h3>
                    <div class="flex space-x-3">
                        <input
                            type="text"
                            id="new-module-name"
                            value="${state.newModuleName}"
                            placeholder="Module Name (e.g., 'Work Mastery')"
                            class="flex-grow p-2 border border-indigo-300 dark:border-indigo-700 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 dark:bg-gray-700 dark:text-white"
                        />
                        <button type="submit" class="bg-indigo-600 text-white px-4 py-2 rounded-lg font-medium hover:bg-indigo-700 transition duration-150 shadow-md">
                            Add Module
                        </button>
                    </div>
                </form>

                <div id="module-list" class="space-y-6"></div>
            `;

            const form = div.querySelector('#add-module-form');
            form.addEventListener('submit', handleAddModule);
            const input = div.querySelector('#new-module-name');
            input.addEventListener('input', (e) =>
            {
                state.newModuleName = e.target.value;
            });


            const moduleListContainer = div.querySelector('#module-list');

            state.config.forEach(module =>
            {
                const moduleDiv = document.createElement('div');
                moduleDiv.className = "bg-white dark:bg-gray-700 p-5 rounded-xl shadow-lg border border-slate-200 dark:border-gray-600";

                const currentRule = module.frequency.rule;
                const currentDays = module.frequency.days || [];
                
                // Build the Day Selection interface if the rule is 'specific_days'
                const daySelectionHtml = currentRule === 'specific_days' ? `
                    <div class="mt-3 space-y-2">
                        <h5 class="text-sm font-semibold text-slate-700 dark:text-slate-300">Select Days:</h5>
                        <div class="grid grid-cols-4 sm:grid-cols-7 gap-2">
                            ${WEEK_DAYS.map(day => `
                                <label class="flex items-center space-x-2 cursor-pointer bg-slate-100 dark:bg-gray-600 p-2 rounded-md hover:bg-indigo-100 dark:hover:bg-indigo-700 transition-colors">
                                    <input 
                                        type="checkbox" 
                                        data-module-id="${module.id}" 
                                        data-day-key="${day.key}"
                                        ${currentDays.includes(day.key) ? 'checked' : ''}
                                        class="day-selector h-4 w-4 text-indigo-600 border-gray-300 focus:ring-indigo-500 dark:border-gray-500 dark:bg-gray-700"
                                    >
                                    <span class="text-xs font-medium text-slate-800 dark:text-slate-200">${day.name.substring(0, 3)}</span>
                                </label>
                            `).join('')}
                        </div>
                        <p class="text-xs text-slate-500 dark:text-slate-400 italic mt-2">Module is only visible on selected days in the tracker.</p>
                    </div>
                ` : '';


                moduleDiv.innerHTML = `
                    <div class="flex justify-between items-start mb-3 border-b pb-2 border-slate-200 dark:border-gray-600">
                        <h4 class="text-lg font-bold text-slate-800 dark:text-slate-100 flex items-center">
                            <span class="mr-2 text-xl">${module.icon}</span> 
                            ${module.name}
                        </h4>
                        ${module.custom ? `<button data-module-id="${module.id}" class="remove-module-btn text-red-500 dark:text-red-400 text-sm hover:text-red-700 dark:hover:text-red-300 transition-colors">
                            Remove Module
                        </button>` : ''}
                    </div>

                    <div class="mb-4 p-3 bg-slate-50 dark:bg-gray-600 rounded-lg border border-slate-200 dark:border-gray-500">
                        <h5 class="text-sm font-semibold mb-2 text-slate-700 dark:text-slate-300">Module Rule & Frequency:</h5>
                        <div class="flex flex-col space-y-2">
                            <select 
                                class="module-rule-selector p-2 border border-gray-300 dark:border-gray-500 rounded-lg text-sm dark:bg-gray-700 dark:text-white"
                                data-module-id="${module.id}"
                            >
                                <option value="all" ${currentRule === 'all' ? 'selected' : ''}>Complete ALL Practices (Daily)</option>
                                <option value="choose_one" ${currentRule === 'choose_one' ? 'selected' : ''}>Complete ONE Practice (Daily)</option>
                                <option value="specific_days" ${currentRule === 'specific_days' ? 'selected' : ''}>Specific Days (Custom Frequency)</option>
                            </select>
                            
                            ${daySelectionHtml}
                        </div>
                    </div>

                    <ul class="space-y-2 mb-4">
                        ${module.practices.map(practice => `
                            <li key="${practice.id}" class="flex justify-between items-center bg-slate-50 dark:bg-gray-600 p-2 rounded-md border border-slate-100 dark:border-gray-500">
                                <span class="text-sm text-slate-800 dark:text-slate-200">${practice.name}</span>
                                <button data-module-id="${module.id}" data-practice-id="${practice.id}" class="remove-practice-btn text-red-400 hover:text-red-600 text-xs font-semibold px-2 py-1 transition-colors">
                                    &times; Remove
                                </button>
                            </li>
                        `).join('')}
                    </ul>

                    <form data-module-id="${module.id}" class="add-practice-form mt-4 flex space-x-2">
                        <input
                            type="text"
                            data-module-id="${module.id}"
                            value="${state.newPracticeTexts[module.id] || ''}"
                            placeholder="New practice for ${module.name}"
                            class="practice-input flex-grow p-2 border border-slate-300 dark:border-gray-500 rounded-lg text-sm focus:ring-indigo-500 focus:border-indigo-500 dark:bg-gray-600 dark:text-white"
                        />
                        <button
                            type="submit"
                            class="bg-indigo-500 text-white text-sm px-3 py-1 rounded-lg hover:bg-indigo-600 transition duration-150"
                        >
                            Add Practice
                        </button>
                    </form>
                `;

                moduleListContainer.appendChild(moduleDiv);
            });

            // Setup event listeners for the dynamically created elements

            // Rule Selector
            div.querySelectorAll('.module-rule-selector').forEach(select =>
            {
                select.addEventListener('change', (e) =>
                {
                    handleUpdateModuleFrequencyRule(e.target.dataset.moduleId, e.target.value);
                });
            });

            // Day Selector Checkboxes
            div.querySelectorAll('.day-selector').forEach(checkbox =>
            {
                checkbox.addEventListener('change', (e) =>
                {
                    handleUpdateModuleFrequencyDays(e.target.dataset.moduleId, e.target.dataset.dayKey, e.target.checked);
                });
            });

            // Remove Module, Remove Practice, Add Practice Form, Practice Input handlers (unchanged)
            div.querySelectorAll('.remove-module-btn').forEach(btn =>
            {
                btn.addEventListener('click', (e) => handleRemoveModule(e.target.dataset.moduleId));
            });
            // ... (other handlers)
            div.querySelectorAll('.remove-practice-btn').forEach(btn =>
            {
                btn.addEventListener('click', (e) => handleRemovePractice(e.target.dataset.moduleId, e.target.dataset.practiceId));
            });

            div.querySelectorAll('.add-practice-form').forEach(form =>
            {
                form.addEventListener('submit', (e) => handleAddPractice(e, form.dataset.moduleId));
            });

            div.querySelectorAll('.practice-input').forEach(input =>
            {
                input.addEventListener('input', (e) =>
                {
                    const moduleId = e.target.dataset.moduleId;
                    state.newPracticeTexts = { ...state.newPracticeTexts, [moduleId]: e.target.value };
                });
            });

            return div;
        }

        // --- Render History View (UPDATED for 'N/A' status) ---
        function renderHistoryView()
        {
            const div = document.createElement('div');
            div.className = "space-y-6";

            div.innerHTML = `
                <h2 class="text-2xl font-extrabold text-slate-800 dark:text-slate-100">Practice History Review</h2>
                <p class="text-slate-600 dark:text-slate-400">Review your past **Module Completion Rate**. Click on a day to see details!</p>
            `;

            const historyContainer = document.createElement('div');
            historyContainer.className = "space-y-8";

            const logDates = Object.keys(state.allLogs).sort(); // Sort ascending for weekly grouping

            if (logDates.length === 0)
            {
                historyContainer.innerHTML = '<p class="p-4 bg-yellow-100 dark:bg-yellow-900 rounded-xl text-yellow-800 dark:text-yellow-300 border border-yellow-300 dark:border-yellow-700">No practice logs found yet. Start tracking your habits on the Daily Tracker!</p>';
            } else
            {
                // Group logs by week (Sunday start)
                const logsByWeek = {};
                for (const dateKey of logDates) {
                    const weekStartKey = getWeekStartKey(dateKey);
                    if (!logsByWeek[weekStartKey]) {
                        logsByWeek[weekStartKey] = [];
                    }
                    logsByWeek[weekStartKey].push(dateKey);
                }

                const weekKeys = Object.keys(logsByWeek).sort().reverse();

                const todayKey = getTodayDateKey();
                const totalModules = state.config.length;

                weekKeys.forEach(weekStartKey => {
                    const weekDiv = document.createElement('div');
                    weekDiv.className = "p-5 bg-white dark:bg-gray-800 rounded-xl shadow-lg border border-indigo-100 dark:border-indigo-900";

                    const weekHeader = document.createElement('h3');
                    weekHeader.className = "text-xl font-bold text-indigo-700 dark:text-indigo-400 mb-3 pb-2 border-b border-indigo-200 dark:border-indigo-800";
                    weekHeader.textContent = `Week of ${formatWeekRange(weekStartKey)}`;
                    weekDiv.appendChild(weekHeader);

                    const dailyLogGrid = document.createElement('div');
                    dailyLogGrid.className = "grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3";
                    
                    // Display days in order, descending
                    const weekLogs = logsByWeek[weekStartKey].sort().reverse(); 

                    weekLogs.forEach(dateKey => {
                        const logEntry = state.allLogs[dateKey];
                        const dateObj = new Date(dateKey + 'T00:00:00');
                        const dayOfWeek = dateObj.toLocaleDateString('en-US', { weekday: 'short' });

                        let completedModulesCount = 0;
                        let scheduledModulesCount = 0;
                        
                        // Calculate stats based on the new isModuleCompleted logic
                        state.config.forEach(module => {
                            const status = isModuleCompleted(module, logEntry.practices, dateKey);
                            if (status !== 'N/A') {
                                scheduledModulesCount++;
                                if (status === true) {
                                    completedModulesCount++;
                                }
                            }
                        });


                        const completionPercentage = scheduledModulesCount > 0 ? Math.round((completedModulesCount / scheduledModulesCount) * 100) : 0;

                        const isToday = dateKey === today
